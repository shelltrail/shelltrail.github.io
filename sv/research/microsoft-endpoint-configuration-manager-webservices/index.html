<!DOCTYPE html>
<html lang="sv-se">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academia 4.3.1">
  <meta name="theme-name" content="academia-hugo"/>

  

  
  
  
  
  
    
    
    
  
  

  

  
  
  
    
  
  <meta name="description" content="New research into an (legacy) extension for Microsoft Endpoint Configuration Manager/SCCM/ConfigMgr reveal new attack paths for Active Directory domain compromise or elevation of privileges.">

  
  <link rel="alternate" hreflang="en" href="https://www.shelltrail.com/research/microsoft-endpoint-configuration-manager-webservices/">
  
  <link rel="alternate" hreflang="sv-se" href="https://www.shelltrail.com/sv/research/microsoft-endpoint-configuration-manager-webservices/">

  


  

  
  
  
  <meta name="theme-color" content="#000000">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    

    

  

  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Open+Sans|Roboto+Mono&display=swap">
  

  
  
  
  <link rel="stylesheet" href="/css/academia.min.d29584a8d689167dc15889efc8f9006e.css">

  

  
  
  
  

  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://www.shelltrail.com/sv/research/microsoft-endpoint-configuration-manager-webservices/">

  
  
  
  
    
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="og:site_name" content="Shelltrail - Experter inom offensiv säkerhet">
  <meta property="og:url" content="https://www.shelltrail.com/sv/research/microsoft-endpoint-configuration-manager-webservices/">
  <meta property="og:title" content="Microsoft Configuration Manager - New attack paths using ConfigMgr WebService extension | Shelltrail - Experter inom offensiv säkerhet">
  <meta property="og:description" content="New research into an (legacy) extension for Microsoft Endpoint Configuration Manager/SCCM/ConfigMgr reveal new attack paths for Active Directory domain compromise or elevation of privileges."><meta property="og:image" content="https://www.shelltrail.com/sv/research/microsoft-endpoint-configuration-manager-webservices/featured.png">
  <meta property="twitter:image" content="https://www.shelltrail.com/sv/research/microsoft-endpoint-configuration-manager-webservices/featured.png"><meta property="og:locale" content="sv-se">
  
  <meta property="article:published_time" content="2023-10-10T00:00:00&#43;00:00">
  
  <meta property="article:modified_time" content="2023-10-31T15:37:00&#43;00:00">
  

  


  





  <title>Microsoft Configuration Manager - New attack paths using ConfigMgr WebService extension | Shelltrail - Experter inom offensiv säkerhet</title>

</head>


<body id="top" data-spy="scroll" data-target="#TableOfContents" data-offset="71" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Sök</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  

<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/sv/"><img src="/img/shelltrail_slim_transparent.png" height="90%" width="90%" alt="Shelltrail - Experter inom offensiv säkerhet"></a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Växla navigering"><span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">
      
      
      <ul class="navbar-nav ml-auto">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/sv/#kostnadsforslag"><span>Kostnadsförslag</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/sv/#tjanster"><span>Tjänster</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/sv/#omoss"><span>Om oss</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/sv/#research"><span>Research</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/sv/#blogg"><span>Blogg</span></a>
        </li>

        
        

      

        

        

        
        <li class="nav-item dropdown">
          <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true">
            <i class="fas fa-globe" aria-hidden="true"></i>
            <span>Svenska</span>
          </a>
          <ul class="dropdown-menu">
            
            <li class="dropdown-item my-0 py-0 mx-0 px-0">
              <a href="https://www.shelltrail.com/research/microsoft-endpoint-configuration-manager-webservices/">
                <span>English</span>
              </a>
            </li>
            
          </ul>
        </li>
        

        

      </ul>
    </div>
  </div>
</nav>


  <article class="article py-5" itemscope itemtype="http://schema.org/Article">

  














<div class="container split-header">
  <div class="row justify-content-center">
    <div class="col-lg-12">
        <img class="img-fluid w-100" src="/sv/research/microsoft-endpoint-configuration-manager-webservices/featured_hu9c3ab0b9383b5962b16647922f46b217_49623_900x500_fill_q90_lanczos_smart1_3.png" itemprop="image" alt="">
        
    </div>
    <div class="col-lg-12">
      <h1 itemprop="name">Microsoft Configuration Manager - New attack paths using ConfigMgr WebService extension</h1>

      

      



<meta content="2023-10-10 00:00:00 &#43;0000 UTC" itemprop="datePublished">
<meta content="2023-10-31 15:37:00 &#43;0000 UTC" itemprop="dateModified">

<div class="article-metadata">

  
  

  

  

  

  

  
  

  
  

  
    
<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://www.shelltrail.com/sv/research/microsoft-endpoint-configuration-manager-webservices/&amp;text=Microsoft%20Configuration%20Manager%20-%20New%20attack%20paths%20using%20ConfigMgr%20WebService%20extension" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://www.shelltrail.com/sv/research/microsoft-endpoint-configuration-manager-webservices/&amp;t=Microsoft%20Configuration%20Manager%20-%20New%20attack%20paths%20using%20ConfigMgr%20WebService%20extension" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook-f"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Microsoft%20Configuration%20Manager%20-%20New%20attack%20paths%20using%20ConfigMgr%20WebService%20extension&amp;body=https://www.shelltrail.com/sv/research/microsoft-endpoint-configuration-manager-webservices/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://www.shelltrail.com/sv/research/microsoft-endpoint-configuration-manager-webservices/&amp;title=Microsoft%20Configuration%20Manager%20-%20New%20attack%20paths%20using%20ConfigMgr%20WebService%20extension" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=Microsoft%20Configuration%20Manager%20-%20New%20attack%20paths%20using%20ConfigMgr%20WebService%20extension%20https://www.shelltrail.com/sv/research/microsoft-endpoint-configuration-manager-webservices/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https://www.shelltrail.com/sv/research/microsoft-endpoint-configuration-manager-webservices/&amp;title=Microsoft%20Configuration%20Manager%20-%20New%20attack%20paths%20using%20ConfigMgr%20WebService%20extension" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>


  

</div>

      














    </div>
    
    </div>
  </div>
</div>


  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      <h2 id="tldr">TL;DR</h2>
<p><a href="https://msendpointmgr.com/configmgr-webservice/">ConfigMgr WebService</a>, a third-party extension used to simplify custom Operating System Deployment (OSD) for
Microsoft Configuration
Manager adds features to interact with Configuration Manager, MDT and Active Directory which under
certain situations can be exploited to escalate privileges in an Active
Directory domain. While the extension is considered legacy by the developer, it may still be
prevalent in several environments.</p>
<h2 id="background">Background</h2>
<p>As part of the research surrounding Microsoft Configuration Manager, Shelltrail has investigated a open source
third-party tool used in OS deployments which interacts with Configuration Manager, MDT and Active
Directory. The tool in question contains two parts, a WebService
endpoint called <a href="https://msendpointmgr.com/configmgr-webservice/">ConfigMgr WebService</a> and a .NET GUI application named <a href="https://msendpointmgr.com/configmgr-osd-frontend/">ConfigMgr OSD FrontEnd</a>.</p>
<p>The tools adds the functionality to create custom Operating System Deployment sequences
via <em>ConfigMgr OSD FrontEnd</em> which exposes a GUI during Windows Preinstallation
Environment (WinPE) where a user or administrator can customize and define
the deployment process by means of using input and checkboxes.</p>
<p><img src="image-showing-osd-frontend-during-pentest.png" alt="Image showing OSD FrontEnd during pentest"></p>
<p>The <em>ConfigMgr OSD FrontEnd</em> (<code>OSDFrontEnd.exe</code>) self-service GUI simplifies
the customization process as the alternative would be for a Configuration manager
administrator to build, and deploy a custom Task Sequence which can be time consuming.</p>
<p>Most options, configuration and ability to communicate with <em>ConfigMgr WebService</em>
for <code>OSDFrontEnd.exe</code> comes from <code>OSDFrontEnd.exe.config</code>
which is provided in the OSDFrontEnd enabled WinPE PXE bootable image.</p>
<p><img src="image-showing-file-structure-on-a-security-assessment.png" alt="Image showing file structure on a security assessment"></p>
<h2 id="configmgr-webservice-authentication">ConfigMgr WebService authentication</h2>
<p>As unauthenticated access to the <em>ConfigMgr WebService</em> could have severe consequences, a basic
authentication mechanism is used, where a secret access key is generated upon installation of
the WebService. The access key is generated as an unguessable type-4 UUID and stored in the <code>web.config</code>
file in the root of the IIS web application.</p>
<p>Upon issuing requests to the WebService the <code>WebServiceSecret</code> need to be supplied and if
it matches the configured key, the request is authorized. As the <em>ConfigMgr OSD FrontEnd</em> need to
know this key in order to make use of the functionality, it is included in the <code>OSDFrontEnd.exe.config</code>
file together with the endpoint with which to interact, as seen in the image below.</p>
<p><img src="web-config-during-active-directory-security-assessment.png" alt="Image showing web.config during Active Directory security assessment"></p>
<p>By obtaining the <code>WebServiceSecretKey</code>, communication can be established with the
<em>ConfigMgr WebService</em>. From here on different exploitation paths may exist, depending on
how the service account is configured for the IIS AppPool running <em>ConfigMgr WebService</em>.</p>
<p><img src="active-directory-attributes-during-internal-security-assessment.png" alt="Image showing active directory attributes during internal security assessment"></p>
<h2 id="configmgr-webservice-permissions">ConfigMgr WebService permissions</h2>
<p>During the setup of <em>ConfigMgr WebService</em> the service account used in IIS
is specified during the <code>Specify Application Pool Identity</code> which can be seen
in <code>ConfigMgr WebService 1.8.0 - Installation Guide.pdf</code> from <a href="https://github.com/MSEndpointMgr/ConfigMgrWebService/releases">ConfigMgr.WebService.1.8.0.zip</a>.</p>
<p><img src="security-settings-service-account.png" alt="Service account in Active Directory"></p>
<p>This service account, which this research essentially is all about, is the key
to keep the environment secure. If this service account is configured with higher
privileges than intended, it may lead to privilege escalations in various ways.</p>
<p>The documentation for <em>ConfigMgr WebService</em> regarding the service accounts'
permissions can be found in three places</p>
<ul>
<li>ConfigMgr WebService 1.8.0 - Installation Guide.pdf - page 3
<ul>
<li><img src="security-permissions-1.png" alt="IT security permissions"></li>
</ul>
</li>
<li>ConfigMgr OSD FrontEnd 1.6.0 - Documentation.pdf - page 35
<ul>
<li><img src="security-permissions-2.png" alt="IT security permissions"></li>
</ul>
</li>
<li><a href="https://github.com/NickolajA/ConfigMgrWebService">https://github.com/NickolajA/ConfigMgrWebService</a>
<ul>
<li><img src="security-permissions-3.png" alt="IT security permission"></li>
</ul>
</li>
</ul>
<p>As the recommended permissions sometimes contradict each other, and may be
quite limited in explanation, administrators may lack proper information
when delegating permissions and end up with an overly privileged service account.</p>
<p>Let&rsquo;s highlight the risks of various permissions.</p>
<h2 id="exploitation">Exploitation</h2>
<p>To highlight some of the exploitation paths that can be used with the exposed
WebService, we&rsquo;ve set up a test environment and misconfigured the service account
used by the WebService in various ways.</p>
<p>Of course, setting up the service account as a member in <code>Domain Admins</code> is probably
the worst scenario where exploitation by WebServices such as <code>AddADUserToGroup</code> or
<code>AddADComputerToGroup</code> should be apparent. While rare, configurations such as this are
encountered from time to time.</p>
<p>To make it a bit more tricky, we&rsquo;ve set up a slightly less obvious configuration where
the following setup of Organizational Units (OU) in the Active Directory is used, which
is not uncommon.</p>
<p><img src="active-directory-security-organizational-units.png" alt="Active Directory security organizational units"></p>
<p>We&rsquo;ve also added the permission of <code>Modify the membership of a group</code> to the service
account to the root of the OU <code>CORP</code>, in order for it to be able to make use of
some of the exposed WebServices.</p>
<h3 id="addadcomputertogroup">AddADComputerToGroup</h3>
<p>We will test out the first functionality of <em>ConfigMgr WebService</em>. Namely
<code>AddADComputerToGroup</code></p>
<p><img src="exploitation-of-active-directory-group-membership.png" alt="Exploitation of Active Directory group membership"></p>
<p>What happened? Local administrator permissions on <code>DEMOMACHINE</code> was given to
the computer <code>mylaptop</code> via the custom group <code>Local Administrators - DEMOMACHINE</code>
which was located in the OU structure.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>$ smbexec.py test.local/mylaptop<span style="color:#ae81ff">\$</span>@DEMOMACHINE
</span></span><span style="display:flex;"><span>Impacket v0.12.0.dev1+20230907.33311.3f645107 - Copyright 2023 Fortra
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>Password:
</span></span><span style="display:flex;"><span>[!] Launching semi-interactive shell - Careful what you execute
</span></span><span style="display:flex;"><span>C:\Windows\system32&gt;whoami
</span></span><span style="display:flex;"><span>nt authority\system
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>C:\Windows\system32&gt;
</span></span></code></pre></div><p>Of course this is a fictitious setup however these types of unintended permissions
exist in most if not all Active Directory environment.</p>
<p>This is caused by unintended
inheritance in Active Directory where the administrator gave the
<em>ConfigMgr WebService</em> service account
<code>Modify the memership of a group</code> to the root if the OU <code>CORP</code>, which included
the group <code>Local Administrators - DEMOMACHINE</code></p>
<p><img src="internal-network-security-for-active-directory.png" alt="Internal network security for Active Directory"></p>
<p>To fix this careful planning of what OU&rsquo;s the service account are allowed to modify
is required.</p>
<h3 id="getadcomputerattributevalue">GetADComputerAttributeValue</h3>
<p>So let&rsquo;s explore how reading a computer attribute can be exploited to move laterally
or escalate privileges. One way would be if Local Administrator Password Solution
(LAPS) is misconfigured:</p>
<p><img src="gaining-laps-password-on-internal-pentest.png" alt="Gaining LAPS password on internal pentest"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>$ smbexec.py administrator:<span style="color:#e6db74">&#39;Mhr9;3KO5}X%6e&#39;</span>@SRV01
</span></span><span style="display:flex;"><span>Impacket v0.12.0.dev1+20230907.33311.3f645107 - Copyright 2023 Fortra
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>[!] Launching semi-interactive shell - Careful what you execute
</span></span><span style="display:flex;"><span>C:\Windows\system32&gt;whoami
</span></span><span style="display:flex;"><span>nt authority\system
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>C:\Windows\system32&gt;
</span></span></code></pre></div><h3 id="addadusertogroup">AddADUserToGroup</h3>
<p>But what if LAPS is not misconfigured? Then misconfigure it by adding the service account
to the to the fictitious <code>LAPS Password readers</code>-group using the handy AddADUserToGroup command:</p>
<p><img src="exploitation-of-laps-during-active-directory-security-assessment.png" alt="Exploitation of LAPS during Active Directory security assessment"></p>
<p>Then fetch <code>ms-mcs-admpwd</code> via <code>GetADComputerAttributeValue</code></p>
<p>Would it also be possible to add a user to <code>Domain Admins</code>? Of course, however this
requires the service account to have permission in either the domain-root or
in the <code>Users</code> container.</p>
<p><img src="active-directory-security-ous.png" alt="Active Directory security OU&amp;rsquo;s"></p>
<h3 id="getaduserattributevalue">GetADUserAttributeValue</h3>
<p>Further on it is also possible to enumerate all computers and users with the <code>GetADUserAttributeValue</code>-service
by inserting wildcard in LDAP queries.</p>
<p><img src="user-enumeration-active-directory.png" alt="User enumeration Active Directory"></p>
<p><img src="user-enumeration-via-brute-force.png" alt="User enumeration via brute force"></p>
<p>With a full user dump of Active Directory users, password spraying and AS-REP attacks are
possible attacks that could be used.</p>
<p>Another classic is to enumerate the <strong>description</strong> field of the Active Directory users,
where administrators sometimes put passwords:</p>
<p><img src="common-active-directory-security-vulnerability.png" alt="Common Active Directory security vulnerability"></p>
<h3 id="setadcomputermanagedby">SetADComputerManagedBy</h3>
<p>The <code>ManagedBy</code> Active Directory attribute should not be confused with the <code>Owner</code>
attribute.
Being <code>Owner</code> of a Active Directory computer object indirectly means administrator
access via the ShadowCredentials attack or Resource Based Constrained Delegation which
is not applicable in this case.
However <code>ManagedBy</code> have two interesting aspects. If <code>ManagedBy</code> is used on a
Active Directory group it is possible to allow the manager to modify membership.</p>
<p><img src="rodcs-security-misconfiguration.png" alt="RODCs security misconfiguration"></p>
<p>Even though the <a href="https://github.com/NickolajA/ConfigMgrWebService/blob/master/ConfigMgrWebService/ConfigMgrWebService.asmx.cs#L5835C63-L5835C111">LDAP query</a> used to lookup
the computer concatenates the user input into the query, basically meaning
LDAP injection.</p>
<p><img src="ldap-injection-vulnerability.png" alt="LDAP injection vulnerability"></p>
<p>No ways of escaping the <em>objectClass=computer</em> was found which
means that Active Directory groups cannot be modified with the
<code>SetADComputerManagedBy</code> feature.</p>
<p>The other interesting aspect is if the <code>ManagedBy</code> attribute is used in conjunction
with Read-Only Domain Controllers (RODC).</p>
<p><img src="remote-code-execution-on-active-directory-read-only-domain-controller.png" alt="Remote code execution on Active Directory read-only domain controller"></p>
<p>The principal configured in the <code>ManagedBy</code> attribute becomes the
<a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/73d11ea7-e634-453e-944d-559654cc91c5">local administrator on the RODC</a>.</p>
<p><img src="managedby2.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@adpen1:~$ smbexec.py test.local/test-lowpriv:&#39;Flowahpowah1&#39;@rodc01
</span></span><span style="display:flex;"><span>Impacket v0.12.0.dev1+20230907.33311.3f645107 - Copyright 2023 Fortra
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>[!] Launching semi-interactive shell - Careful what you execute
</span></span><span style="display:flex;"><span>C:\Windows\system32&gt;whoami
</span></span><span style="display:flex;"><span>nt authority\system
</span></span></code></pre></div><h2 id="more-recon">More recon</h2>
<p>Until now all attacks originates from having PXE bootable network access with the
ability to boot a WinPE configured with <em>ConfigMgr OSD FrontEnd</em>. This limitation
can be extended in three ways.</p>
<p>In order to include <em>ConfigMgr OSD FrontEnd</em> to a bootable WinPE the source files must
be injected to the image. In order for this to work Configuration Manager
requires <em>Source directory</em> for the <em>ConfigMgr OSD FrontEnd</em> files
to be imported via a UNC path:</p>
<p><img src="configuration-manager-security-share.png" alt="Configuration Manager security share"></p>
<p><em>Everybody calm down, I&rsquo;ve got this</em> the administrator says, right-clicks the
folder, chooses share and done.</p>
<p>What just happened is a very common issue in Windows corporate environments. As the
default permissions on a local folder outside of home folders for example, includes
<code>&lt;computername&gt;\Users</code> with read permissions:</p>
<p><img src="active-directory-security-tab-on-share.png" alt="Active Directory security tab on share"></p>
<p>Which via nesting includes <code>&lt;domain&gt;\Domain Users</code>:</p>
<p><img src="internal-security-review-of-windows-users.png" alt="Internal security review of Windows - Users"></p>
<p>Now every authenticated user in the domain has the permissions to access the secret
key in the <code>OSDFrontEnd.exe.config</code> file.</p>
<h2 id="more-recon-2">More recon #2</h2>
<p>OK, so the <code>sources</code> folder in the previous example is now properly secured and
no means of obtaining the <code>OSDFrontEnd.exe.config</code> is possible. But wait&hellip;</p>
<p>We turn to our nifty tool <a href="https://github.com/shelltrail/cmloot">cmloot.py</a>, to
index all files in the SCCM inventory:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@pentest:~$ cmloot.py test.local/test-lowpriv@sccm01 -cmlootinventory sccmfiles.txt
</span></span><span style="display:flex;"><span>Impacket v0.12.0.dev1+20231004.192432.3760dfc6 - Copyright 2023 Fortra
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>[+] Access to SCCMContentLib
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>[+] sccmfiles.txt created
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>user@pentest:~/cmloot$
</span></span></code></pre></div><p>As the WinPE&rsquo;s are distributed to the Distribution Points running the Configuration
Manager PXE service it will be stored in the <code>SCCMContentLib$</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@adpen1:~$ cat sccmfiles.txt | grep &#39;\.wim&#39;
</span></span><span style="display:flex;"><span>\\sccm01\SCCMContentLib$\DataLib\XYZ00002.3\boot.XYZ00002.wim
</span></span><span style="display:flex;"><span>\\sccm01\SCCMContentLib$\DataLib\XYZ00006.9\winpe_dotnet.XYZ00006.wim
</span></span><span style="display:flex;"><span>\\sccm01\SCCMContentLib$\DataLib\XYZ00007.3\winpe.XYZ00007.wim
</span></span><span style="display:flex;"><span>\\sccm01\SCCMContentLib$\DataLib\XYZ0000C.2\winpe.XYZ0000C.wim
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>$ cmloot.py test.local/test-lowpriv@sccm01 -n -cmlootdownload sccmfiles.txt -extensions wim
</span></span><span style="display:flex;"><span>Impacket v0.11.0 - Copyright 2023 Fortra
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>[+] Extensions to download [&#39;wim&#39;]
</span></span><span style="display:flex;"><span>[+] Downloaded 7E2C-boot.XYZ00002.wim
</span></span><span style="display:flex;"><span>[+] Downloaded 007F-winpe_dotnet.XYZ00006.wim
</span></span><span style="display:flex;"><span>[+] Downloaded 9599-winpe.XYZ00007.wim
</span></span><span style="display:flex;"><span>[+] Downloaded 4B5C-winpe.XYZ0000C.wim
</span></span></code></pre></div><p>The <code>.wim</code> files can easily be extracted with 7-zip:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@adpen1:~/CMLootOut$ 7z x 007F-winpe_dotnet.XYZ00006.wim
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>7-Zip [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21
</span></span><span style="display:flex;"><span>p7zip Version 16.02 (locale=en_US.UTF-8,Utf16=on,HugeFiles=on,64 bits,4 CPUs Intel(R) Core(TM) i7-8565U CPU @ 1.80GHz (806EC),ASM,AES-NI)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>Scanning the drive for archives:
</span></span><span style="display:flex;"><span>1 file, 425193731 bytes (406 MiB)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>Extracting archive: 007F-winpe_dotnet.XYZ00006.wim
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>[...]
</span></span></code></pre></div><p>After this we just extract the key from the config-file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@adpen1:~/CMLootOut$ cat sms/PKG/SMS10000/OSDFrontEnd.exe.config | grep SecretKey -A1
</span></span><span style="display:flex;"><span>            &lt;setting name=&#34;WebServiceSecretKey&#34; serializeAs=&#34;String&#34;&gt;
</span></span><span style="display:flex;"><span>                &lt;value&gt;134ef495-4991-41df-9fa3-27c1a736de85&lt;/value&gt;
</span></span></code></pre></div><h2 id="more-recon-3">More recon #3</h2>
<p>OK, so what if the administrator restricts permissions on the <code>SCCMContentLib$</code>
(Actually don&rsquo;t know if this is supported). No problem, you can download the <code>.wim</code>
files directly from the Configuration Manager PXE server but only if Configuration i
Manager is using WDS for the PXE services.</p>
<p>According to TFTP&rsquo;s <a href="https://www.rfc-editor.org/rfc/rfc1350">RFC</a> you cannot list
directories or files which means you need to guess the file names
for the <code>.wim</code> files. Luckily, <code>cmloot.py</code> did this for us in the previous example.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@adpen1:~$ cat sccmfiles.txt | grep -i winpe
</span></span><span style="display:flex;"><span>\\sccm01\SCCMContentLib$\DataLib\XYZ00006.9\winpe_dotnet.XYZ00006.wim
</span></span><span style="display:flex;"><span>\\sccm01\SCCMContentLib$\DataLib\XYZ00007.3\winpe.XYZ00007.wim
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@adpen1:~$ atftp 100.64.5.221 69 -l winpe_dotnet.XYZ00006.wim -g -r &#39;SMSImages\\XYZ00006\\winpe_dotnet.XYZ00006.wim&#39;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>user@adpen1:~$ file winpe_dotnet.XYZ00006.wim
</span></span><span style="display:flex;"><span>winpe_dotnet.XYZ00006.wim: Windows imaging (WIM) image v1.13, bootable no. 1, LZX compressed, reparse point fixup
</span></span></code></pre></div><p>If the Configuration Manager PXE use <code>sccmpxe.exe</code> as opposed to WDS PXE this does
not work as the WinPE file location is dynamically generated during the PXE process, and
does not rely on static paths.</p>
<h2 id="conclusions-and-recommendations">Conclusions and Recommendations</h2>
<p>As we&rsquo;ve seen in this blog post there are several exploitation paths that could
be used by an attacker depending on how the service account is configured. We&rsquo;ve also
seen that keeping the <code>WebServiceSecretKey</code> can be a bit of a challenge if the
<em>ConfigMgr WebService</em> is in use.</p>
<p>As some of the methods to obtaining the <code>WebServiceSecretKey</code> without being authenticated in the
Active Directory domain exist these can serve as an initial access vector on a internal network.</p>
<p>To limit the exploitation it is recommended to use the principle of least privilege
on the service account, ensuring that the minimal permissions possible are given.</p>
<p>A shortlist of what to avoid can be:</p>
<ul>
<li>To <strong>not</strong> include the service account in highly privileged groups.</li>
<li>To limit the ability for the service account to add users and computers to groups or modify objects other than a limited set of allowed entities.</li>
<li>Limit the ability for the usage of SetADComputerManagedBy if RODCs are used in the environment.</li>
</ul>
<h2 id="note-from-the-developer">Note from the developer</h2>
<p><em>ConfigMgr WebService</em> last release was back in 2019 and has since stopped developing. The
developer is considering the project legacy and recommends not to use it.</p>

    </div>

    



    
      








  





  
  
  
    
  
  
  <div class="media author-card" itemscope itemtype="http://schema.org/Person">
    

    <div class="media-body">
      <h5 class="card-title" itemprop="name"><a href="https://www.shelltrail.com/"></a></h5>
      
      
      <ul class="network-icon" aria-hidden="true">
        
      </ul>
    </div>
  </div>



      
      
    

    

    


  </div>
</article>

      

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script>
        
      

      
      
    

    
    

    
    
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    

    
    

    

    
    

    
    

    
    
    
    
    
    
    
    
    
    
    
    
    <script src="/js/academia.min.6c2ba2801d406881b3c2277043cedd76.js"></script>

    






  
  <div class="container">
    <footer class="site-footer">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-6 mb-4 mb-md-0">
        
        <p class="mb-0">
          Copyright © 2025 &middot; 
	  Shelltrail AB 559319-6164
        </p>
      </div>
      <div class="col-md-6">
        <ul class="list-inline network-icon text-right mb-0">
          
          
        </ul>
      </div>
    </div>
  </div>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Citera</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Kopiera
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Ladda ner
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
