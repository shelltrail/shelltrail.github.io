<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academia 4.3.1">
  <meta name="theme-name" content="academia-hugo"/>

  

  
  
  
  
  
    
    
    
  
  

  

  
  
  
    
  
  <meta name="description" content="Follow along a journey to find vulnerabilities in the RPC functionaliy of ManageEngine ADAudit">

  
  <link rel="alternate" hreflang="en-us" href="https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part1/">

  


  

  
  
  
  <meta name="theme-color" content="#000000">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    

    

  

  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Open+Sans|Roboto+Mono&display=swap">
  

  
  
  
  <link rel="stylesheet" href="/css/academia.min.d29584a8d689167dc15889efc8f9006e.css">

  

  
  
  
  

  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part1/">

  
  
  
  
    
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="og:site_name" content="Shelltrail - Swedish offensive security experts">
  <meta property="og:url" content="https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part1/">
  <meta property="og:title" content="ManageEngine ADAudit - Reverse engineering Windows RPC to find CVEs - part 1 / RPC | Shelltrail - Swedish offensive security experts">
  <meta property="og:description" content="Follow along a journey to find vulnerabilities in the RPC functionaliy of ManageEngine ADAudit"><meta property="og:image" content="https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part1/featured.png">
  <meta property="twitter:image" content="https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part1/featured.png"><meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2024-05-27T00:00:00&#43;00:00">
  
  <meta property="article:modified_time" content="2024-05-27T00:00:00&#43;00:00">
  

  


  





  <title>ManageEngine ADAudit - Reverse engineering Windows RPC to find CVEs - part 1 / RPC | Shelltrail - Swedish offensive security experts</title>

</head>


<body id="top" data-spy="scroll" data-target="#TableOfContents" data-offset="71" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  

<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/"><img src="/img/shelltrail_slim_transparent.png" height="90%" width="90%" alt="Shelltrail - Swedish offensive security experts"></a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation"><span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">
      
      
      <ul class="navbar-nav ml-auto">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#proposal"><span>Proposal</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#webshop"><span>Webshop</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#services"><span>Services</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>About us</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#research"><span>Research</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#blog"><span>Blog</span></a>
        </li>

        
        

      

        

        

        

        

      </ul>
    </div>
  </div>
</nav>


  <article class="article py-5" itemscope itemtype="http://schema.org/Article">

  














<div class="container split-header">
  <div class="row justify-content-center">
    <div class="col-lg-12">
        <img class="img-fluid w-100" src="/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part1/featured_huea717316e325863ad8e107da661c4d1b_87294_900x500_fill_q90_lanczos_smart1_3.png" itemprop="image" alt="">
        
    </div>
    <div class="col-lg-12">
      <h1 itemprop="name">ManageEngine ADAudit - Reverse engineering Windows RPC to find CVEs - part 1 / RPC</h1>

      

      



<meta content="2024-05-27 00:00:00 &#43;0000 UTC" itemprop="datePublished">
<meta content="2024-05-27 00:00:00 &#43;0000 UTC" itemprop="dateModified">

<div class="article-metadata">

  
  

  

  

  

  

  
  

  
  

  
    
<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part1/&amp;text=ManageEngine%20ADAudit%20-%20Reverse%20engineering%20Windows%20RPC%20to%20find%20CVEs%20-%20part%201%20/%20RPC" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part1/&amp;t=ManageEngine%20ADAudit%20-%20Reverse%20engineering%20Windows%20RPC%20to%20find%20CVEs%20-%20part%201%20/%20RPC" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook-f"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=ManageEngine%20ADAudit%20-%20Reverse%20engineering%20Windows%20RPC%20to%20find%20CVEs%20-%20part%201%20/%20RPC&amp;body=https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part1/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part1/&amp;title=ManageEngine%20ADAudit%20-%20Reverse%20engineering%20Windows%20RPC%20to%20find%20CVEs%20-%20part%201%20/%20RPC" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=ManageEngine%20ADAudit%20-%20Reverse%20engineering%20Windows%20RPC%20to%20find%20CVEs%20-%20part%201%20/%20RPC%20https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part1/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part1/&amp;title=ManageEngine%20ADAudit%20-%20Reverse%20engineering%20Windows%20RPC%20to%20find%20CVEs%20-%20part%201%20/%20RPC" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>


  

</div>

      














    </div>
    
    </div>
  </div>
</div>


  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      <h2 id="tldr">TL;DR</h2>
<p>This research consist of three parts covering different areas namely
developing a custom RPC client, reverse engineering and a bit of cryptography.</p>
<p>When this research started, the objective was actually to find a new way to
leverage an old CVE, however digging into the product a new rabbit
hole appeared, leading to a new vulnerability.</p>
<p>This part of the research explains intricate parts of Remote Procedure Calls
(RPC) in Windows environments and how to develop a custom client.</p>
<p>CVEs:</p>
<ul>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-36036">https://nvd.nist.gov/vuln/detail/CVE-2024-36036</a></li>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-36037">https://nvd.nist.gov/vuln/detail/CVE-2024-36037</a></li>
</ul>
<h2 id="background">Background</h2>
<p>ManageEngine is a company with around 50 different products ranging from full
SIEM solutions to Mobile Device Management systems with 280 000+ customers
world-wide. This article will deep-dive into ADAudit Plus, which is a product
used for real-time monitoring of Active Directory, Windows file servers and
Windows configuration change auditing.</p>
<p>ADAudit can remotely access event logs and other statistics using standard
remote interaction tools available in Windows. However, for comprehensive
visibility and specialized functions on the targeted machines, it is necessary
to install an agent on the audited Windows systems, specifically the
<code>ADAuditPlusAgent</code>.</p>
<p>When this research started, the objective was actually to find a new way to
leverage an old CVE, however digging into the product a new rabbit
hole appeared, leading to a new vulnerability..</p>
<p>As the old CVE was fixed, the research had to be conducted on an older version
of ADAudit,
more precisely the <a href="https://www.manageengine.com/products/active-directory-audit/adaudit-plus-release-notes.html">version 7050 released December 2021</a></p>
<p>ManageEngine have a penchant for building applications on top of Tomcat with Java
which makes it a good target to practice some source code analysis and reverse
engineering. Lets begin digging.</p>
<h2 id="methodology">Methodology</h2>
<p>For those who are not familiar with Java and decompiling, here is Shelltrail&rsquo;s
methodology:</p>
<p>Find all .jar files you would like to assess and download them to your
Unix host. The jar files will most likely be stored in the installation
directory of the product that is being assessed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>user@adpen1:~/adaudit/7$ ls -la
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">8036</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">2</span> user user    <span style="color:#ae81ff">4096</span> Dec  <span style="color:#ae81ff">1</span> 08:36 .
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">5</span> user user    <span style="color:#ae81ff">4096</span> Dec  <span style="color:#ae81ff">1</span> 08:35 ..
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> user user  <span style="color:#ae81ff">997934</span> Dec  <span style="color:#ae81ff">1</span> 08:36 AdventNetADAPClient.jar
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> user user   <span style="color:#ae81ff">12040</span> Dec  <span style="color:#ae81ff">1</span> 08:36 AdventnetADAPFilter.jar
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> user user  <span style="color:#ae81ff">139792</span> Dec  <span style="color:#ae81ff">1</span> 08:36 AdventNetADAPJspClient.jar
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> user user <span style="color:#ae81ff">4534195</span> Dec  <span style="color:#ae81ff">1</span> 08:36 AdventnetADAPServer.jar
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> user user   <span style="color:#ae81ff">15735</span> Dec  <span style="color:#ae81ff">1</span> 08:36 AdventnetADAPService.jar
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> user user   <span style="color:#ae81ff">68066</span> Dec  <span style="color:#ae81ff">1</span> 08:36 AdventnetADAPStartUp.jar
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> user user  <span style="color:#ae81ff">686147</span> Dec  <span style="color:#ae81ff">1</span> 08:36 AdventNetClientComponents.jar
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> user user  <span style="color:#ae81ff">290027</span> Dec  <span style="color:#ae81ff">1</span> 08:36 AdventNetClientFramework.jar
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> user user   <span style="color:#ae81ff">65094</span> Dec  <span style="color:#ae81ff">1</span> 08:36 AdventNetIdiomsGallery.jar
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> user user  <span style="color:#ae81ff">294662</span> Dec  <span style="color:#ae81ff">1</span> 08:36 AdventNetNPrevalent.jar
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> user user  <span style="color:#ae81ff">104252</span> Dec  <span style="color:#ae81ff">1</span> 08:36 AdventNetRssLibrary.jar
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> user user  <span style="color:#ae81ff">157667</span> Dec  <span style="color:#ae81ff">1</span> 08:36 AdventNetTableComponents.jar
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> user user  <span style="color:#ae81ff">781984</span> Dec  <span style="color:#ae81ff">1</span> 08:36 AdventNetUpdateManagerInstaller.jar
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> user user   <span style="color:#ae81ff">22935</span> Dec  <span style="color:#ae81ff">1</span> 08:36 AdventNetWebClientCore.jar
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> user user   <span style="color:#ae81ff">13413</span> Dec  <span style="color:#ae81ff">1</span> 08:36 AdventNetWebClientRangeNavigator.jar
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> user user   <span style="color:#ae81ff">13809</span> Dec  <span style="color:#ae81ff">1</span> 08:36 AdventNetWebClientTree.jar
</span></span></code></pre></div><p>Jar-files is an acronym for Java Archive. It is a file format based on the
popular ZIP file format and is used for archiving many files into one.</p>
<p>So yes, it is possible to extract the jar file with a zip tool and retrieve
the content:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>user@adpen1:~/adaudit/7$ 7z l AdventNetADAPClient.jar
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>2021-12-30 21:37:22 D....            <span style="color:#ae81ff">0</span>            <span style="color:#ae81ff">0</span>  com/adventnet/sym/adsm/common/webclient/tracker
</span></span><span style="display:flex;"><span>2021-12-30 21:37:22 D....            <span style="color:#ae81ff">0</span>            <span style="color:#ae81ff">0</span>  com/adventnet/sym/adsm/common/webclient/tree
</span></span><span style="display:flex;"><span>2021-12-30 21:37:22 D....            <span style="color:#ae81ff">0</span>            <span style="color:#ae81ff">0</span>  com/adventnet/sym/adsm/common/webclient/util
</span></span><span style="display:flex;"><span>2021-12-30 21:37:22 .....         <span style="color:#ae81ff">3836</span>         <span style="color:#ae81ff">1804</span>  com/adventnet/sym/adsm/auditing/webclient/compliance/ComplianceDEReportHandler.class
</span></span><span style="display:flex;"><span>2021-12-30 21:37:22 .....        <span style="color:#ae81ff">43842</span>        <span style="color:#ae81ff">17323</span>  com/adventnet/sym/adsm/auditing/webclient/compliance/ComplianceReportHandler.class
</span></span><span style="display:flex;"><span>2021-12-30 21:37:22 .....         <span style="color:#ae81ff">1857</span>          <span style="color:#ae81ff">764</span>  com/adventnet/sym/adsm/auditing/webclient/ember/api/ADAPAPIServlet.class
</span></span><span style="display:flex;"><span>2021-12-30 21:37:22 .....         <span style="color:#ae81ff">1884</span>          <span style="color:#ae81ff">774</span>  com/adventnet/sym/adsm/auditing/webclient/ember/api/ADAPAgentAPIServlet.class
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>This will give you the class files stored in the Jar, however class files
are Java code compiled into Java bytecode which is interpreted by
Java Virtual Machine (JVM) and therefore is not human readable.</p>
<p><a href="https://github.com/java-decompiler/jd-gui">jd-gui</a> is a good tool for
decompiling individual Jar files into a human readable format for analysis
but it does not scale well when you have many files.</p>
<p>To automate this process, <a href="https://github.com/intoolswetrust/jd-cli">jd-cli</a>
can be used to unzip and decompile the Jar files - making them searchable and
viewable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>user@adpen1:~/adaudit/7$ jd-cli *.jar 
</span></span><span style="display:flex;"><span>09:51:11.097 INFO  com.github.kwart.jd.cli.Main - Decompiling AdventNetADAPClient.jar
</span></span><span style="display:flex;"><span>09:51:11.107 INFO  com.github.kwart.jd.output.ZipOutput - ZIP file output will be initialized - AdventNetADAPClient.src.jar
</span></span><span style="display:flex;"><span>09:51:14.930 INFO  com.github.kwart.jd.output.ZipOutput - Finished with <span style="color:#ae81ff">129</span> class file<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> and <span style="color:#ae81ff">1</span> resource file<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> written.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>user@adpen1:~/adaudit/7$ mkdir src
</span></span><span style="display:flex;"><span>user@adpen1:~/adaudit/7$ cd src
</span></span><span style="display:flex;"><span>user@adpen1:~/adaudit/7/src$ find ../ -name <span style="color:#e6db74">&#39;*src.jar&#39;</span> -exec unzip -o <span style="color:#f92672">{}</span> <span style="color:#ae81ff">\;</span>
</span></span><span style="display:flex;"><span>Archive:  ../AdventNetUpdateManagerInstaller.src.jar
</span></span><span style="display:flex;"><span>  inflating: META-INF/MANIFEST.MF    
</span></span><span style="display:flex;"><span>  inflating: com/adventnet/tools/update/installer/images/context_help.png  
</span></span><span style="display:flex;"><span>  inflating: com/adventnet/tools/update/installer/images/context_install.png  
</span></span><span style="display:flex;"><span>  inflating: com/adventnet/tools/update/installer/images/error.png  
</span></span><span style="display:flex;"><span>  inflating: com/adventnet/tools/update/installer/images/help_icon.png  
</span></span><span style="display:flex;"><span>  inflating: com/adventnet/tools/update/installer/images/import.png  
</span></span><span style="display:flex;"><span>  inflating: com/adventnet/tools/update/installer/images/info.png 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>From this point, the analysis of the source code could be initiated.</p>
<h2 id="discovery">Discovery</h2>
<p>What shifted the focus from the initial target was the interest in the functionality
to interact and fetch information from Windows machines with the <code>ADAuditPlusAgent</code>
installed. The <code>ADAuditPlusAgent</code> has many features which can be activated
from the ADAudit server, one of these are a so called
<code>SessionMonitoring</code> feature. This feature starts a process that takes
screenshots at a set interval, and sends them to the central server.
This allows the server to create videos of configuration state changes and
connect them with events. As an example it is possible for the low privileged
user in the agent machine can get a video session of an administrator deleting
a critical configuration file.</p>
<p>Sounds like a fun feature to review, doesn&rsquo;t it?</p>
<p>When enabling the <code>SessionMonitoring</code> feature from the ADAudit server while analysing all
the traffic sent to the agent with wireshark an RPC interaction via named pipes
was discovered.</p>
<p><img src="wireshark-output-showing-rpc-interaction.png" alt="wireshark-output-showing-rpc-interaction"></p>
<p>Hmm interesting! Lets first dwelve into the history of DCE RPC.</p>
<h2 id="dce-rpc--msrpc">DCE RPC / MSRPC</h2>
<p>DCE RPC or Distributed Computing Environment Remote Procedure Call is a protocol
used in client to server
interactions and is general term in computer science and not something only
available on Windows Systems.</p>
<p>Microsoft however wanted their own flavour and developed MSRPC (Microsoft
Remote Procedure Call) with the introduction of Windows NT, first
released in 1993. RPC is an old protocol but it is the foundation of
how inter-computer communication works in Windows environments.</p>
<p>So basically how RPC works is that a Interface Definition Language (IDL)
is defined that exposes procedures to clients. The IDL also defines
how the client should interact with parameters such as a UUID, version
and optionally a handle.</p>
<pre tabindex="0"><code>[
    uuid(7a98c250-6808-11cf-b73b-00aa00b677a7),
    version(1.0),
    implicit_handle(handle_t ImplicitHandle)
]

interface hello
{
    void HelloProc([in, string] unsigned char * pszString);
    void Shutdown(void);
}
</code></pre><p>The first part which is called the IDL header. This header should contain a UUID to not
conflict with other RPC interfaces, a version number, and can utilize three different
handles; explicit, implicit and automatic.</p>
<p>The second part, also known as the IDL body states the procedures that the
client can interact with.</p>
<p>When connecting to the server a binding to the RPC interface must be initialized. This
can be either <code>ncacn_ip_tcp</code>, <code>ncalrpc</code> or <code>ncacn_np</code></p>
<p><strong>ncacn_ip_tcp</strong> uses plain TCP communication to interact with the server. For
this binding to work the RPC server must be configured with a static TCP port
that is reachable. This does not require authentication in order to establish a
connection to the RPC, leaving all authentication responsibility to
the exposed procedure on the server. The initial connection to the RPC is
done over TCP/135.</p>
<p>Example: <code>ncacn_ip_tcp:100.64.5.212[49670]</code></p>
<p><strong>ncalrpc</strong> is used for local RPC interactions which should not be exposed
over the network.</p>
<p>Example: <code>ncalrpc:[LRPC-dfdb2238aff756a07c]</code></p>
<p><strong>ncacn_np</strong> Lets the client and server negotiate TCP port for interaction
and the negotiation occurs over SMB. Meaning this type of binding
requires username and password to connect to SMB, if anonymous sessions
are not enabled.</p>
<p>Example: <code>ncacn_np:100.64.5.212[\pipe\hello]</code></p>
<h2 id="exploitation">Exploitation</h2>
<p>What we know up to this part is actually only that the ADAudit server is using
RPC to interact with the Agents over a named pipe called <code>ADAPAgentRpcPipe</code> as
seen in the wirehark screenshot.</p>
<p>What we now need to do is:</p>
<ul>
<li><input disabled="" type="checkbox"> Create a valid IDL structure</li>
<li><input disabled="" type="checkbox"> Brew a large can of coffee</li>
<li><input disabled="" type="checkbox"> Build an RPC client</li>
<li><input disabled="" type="checkbox"> Guess a lot</li>
<li><input disabled="" type="checkbox"> Create input data that will be marshalled into a valid stub that servers RPC interface will act on.</li>
</ul>
<p>Lets begin with the IDL structure. <a href="https://www.rpcview.org/">RpcView</a> have
everything we need to accomplish this step as the tool can decompile the
IDL structure from the RPC interface. This tool should be executed on the server
exposing the RPC interface:</p>
<p><img src="using-rpcview-to-decompile-idl-structure-of-rpc-interface.png" alt="using-rpcview-to-decompile-idl-structure-of-rpc-interface"></p>
<p>Get the Visual Studio 2022 installer from <a href="https://visualstudio.microsoft.com/downloads/">https://visualstudio.microsoft.com/downloads/</a></p>
<p>Choose to install <em>Desktop developments with C++</em></p>
<p><img src="installing-visual-studio-c++.png" alt="installing-visual-studio-c++"></p>
<p>Make sure Windows SDK is selected as this packages contains the necessary
components to craft the RPC client:</p>
<p><img src="installing-windows-sdk.png" alt="installing-windows-sdk"></p>
<p>Fire up a Visual Studio 2022 and initiate a C++ console app project.</p>
<p>Start by changing the project build options to <code>Release</code> and <code>x64</code> in order
to not require debug runtime libraries when running the compiled binary outside
of the build machine.</p>
<p><img src="compiling-c-idl-header-in-visual-studio.png" alt="compiling-c-idl-header-in-visual-studio"></p>
<p>Create a file named <code>ADAPAgentRpcPipe.idl</code> in the <em>Source Files</em> structure in Visual Studio:</p>
<p><img src="create-idl-file-in-visual-studio.png" alt="create-idl-file-in-visual-studio"></p>
<p>Copy the decompiled IDL structure which was exported by RpcView to the newly created file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">uuid</span>(<span style="color:#ae81ff">7</span>a98c250<span style="color:#f92672">-</span><span style="color:#ae81ff">6808</span><span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>cf<span style="color:#f92672">-</span>b73b<span style="color:#f92672">-</span><span style="color:#ae81ff">00</span>aa00b677a7),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">version</span>(<span style="color:#ae81ff">1.0</span>),
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>interface DefaultIfName
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Proc0</span>(
</span></span><span style="display:flex;"><span>		[in]<span style="color:#66d9ef">long</span> arg_0,
</span></span><span style="display:flex;"><span>		[in][out]<span style="color:#66d9ef">long</span><span style="color:#f92672">*</span> arg_1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Proc1</span>(
</span></span><span style="display:flex;"><span>		[in]<span style="color:#66d9ef">long</span> arg_0,
</span></span><span style="display:flex;"><span>		[in][string] <span style="color:#66d9ef">wchar_t</span><span style="color:#f92672">*</span> arg_1,
</span></span><span style="display:flex;"><span>		[in][out]<span style="color:#66d9ef">long</span><span style="color:#f92672">*</span> arg_2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Proc2</span>(
</span></span><span style="display:flex;"><span>		[in][out]<span style="color:#66d9ef">long</span><span style="color:#f92672">*</span> arg_0,
</span></span><span style="display:flex;"><span>		[in][out]<span style="color:#66d9ef">long</span><span style="color:#f92672">*</span> arg_1);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Right click the file in Visual Studio and choose <em>compile</em> -
Visual Studio will use <code>midl.exe</code> to compile the IDL file into C code which will handle the
appropriate marshalling operations.</p>
<p>Marshalling is the process of converting data objects and parameters into a
state that can be transmitted over a network. This is crucial when transporting
complex data structures.</p>
<p>The data sent to the RPC server when pushing commands to the
ManageEngine ADAudit Agent can actually be viewed
in the DCERPC request in the <code>Stub data</code> section. An exception to this
visibility is if the server defaults to SMB3, then event the <code>Stub data</code> section
is encrypted. In the following image the server is using SMB2:</p>
<p><img src="rpc-stub-data.png" alt="rpc-stub-data"></p>
<p>Back to the project; after compiling of the IDL structure there should now be three new files in
the visual studio project folder:</p>
<ul>
<li><code>ADAPAgentRpcPipe_c.c</code>: _c for client</li>
<li><code>ADAPAgentRpcPipe_h.h</code>: _h for header</li>
<li><code>ADAPAgentRpcPipe_s.c</code>: _s for server</li>
</ul>
<p><img src="compiled-idl-structure.png" alt="compiled-idl-structure"></p>
<ul>
<li><input checked="" disabled="" type="checkbox"> Create a valid IDL structure. Done.</li>
</ul>
<p>Next up, coffee:</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> Brew a large can of coffee</li>
</ul>
<p>With the IDL structure complete and coffee ready the next step is to build the
RPC client. Microsoft provides <a href="https://learn.microsoft.com/en-us/windows/win32/rpc/the-client-application">example code</a>
specifying how to build an RPC client and server application.
The public code will be used as a skeleton for our ADAuditRPC-client so it is
copied to a file named <code>adauditrpc-client.cpp</code> under <em>Source Files</em> in
Visual Studio (use any existing main cpp file or create a new one)</p>
<p>Example code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* file: helloc.c */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ctype.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;hello.h&#34; </span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    RPC_STATUS status;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> pszUuid             <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> pszProtocolSequence <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ncacn_np&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> pszNetworkAddress   <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> pszEndpoint         <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">pipe</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">hello&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> pszOptions          <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> pszStringBinding    <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> pszString           <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello, world&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> ulCode;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    status <span style="color:#f92672">=</span> <span style="color:#a6e22e">RpcStringBindingCompose</span>(pszUuid,
</span></span><span style="display:flex;"><span>                                     pszProtocolSequence,
</span></span><span style="display:flex;"><span>                                     pszNetworkAddress,
</span></span><span style="display:flex;"><span>                                     pszEndpoint,
</span></span><span style="display:flex;"><span>                                     pszOptions,
</span></span><span style="display:flex;"><span>                                     <span style="color:#f92672">&amp;</span>pszStringBinding);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (status) <span style="color:#a6e22e">exit</span>(status);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    status <span style="color:#f92672">=</span> <span style="color:#a6e22e">RpcBindingFromStringBinding</span>(pszStringBinding, <span style="color:#f92672">&amp;</span>hello_ClientIfHandle);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (status) <span style="color:#a6e22e">exit</span>(status);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    RpcTryExcept  
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">HelloProc</span>(pszString);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Shutdown</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">RpcExcept</span>(<span style="color:#ae81ff">1</span>) 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        ulCode <span style="color:#f92672">=</span> <span style="color:#a6e22e">RpcExceptionCode</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Runtime reported exception 0x%lx = %ld</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ulCode, ulCode);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    RpcEndExcept
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    status <span style="color:#f92672">=</span> <span style="color:#a6e22e">RpcStringFree</span>(<span style="color:#f92672">&amp;</span>pszStringBinding); 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (status) <span style="color:#a6e22e">exit</span>(status);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    status <span style="color:#f92672">=</span> <span style="color:#a6e22e">RpcBindingFree</span>(<span style="color:#f92672">&amp;</span>hello_IfHandle);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (status) <span style="color:#a6e22e">exit</span>(status);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/******************************************************/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*         MIDL allocate and free                     */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/******************************************************/</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> __RPC_FAR <span style="color:#f92672">*</span> __RPC_USER <span style="color:#a6e22e">midl_user_allocate</span>(<span style="color:#66d9ef">size_t</span> len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>(<span style="color:#a6e22e">malloc</span>(len));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> __RPC_USER <span style="color:#a6e22e">midl_user_free</span>(<span style="color:#66d9ef">void</span> __RPC_FAR <span style="color:#f92672">*</span> ptr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">free</span>(ptr);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The first modification we need to do is to replace the filename on line 1 and
line 5 <code>#include &quot;hello.h&quot;</code> to
<code>#include &quot;ADAPAgentRpcPipe_h.h&quot;</code> as we have compiled our own header file
created via the IDL file. In addition to we add a line with <code>#pragma comment(lib, rpcrt4.lib&quot;)</code> to
be able to create RPC bindings.</p>
<p>The result:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span><span style="color:#f92672">- /* file: helloc.c */
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span>  #include &lt;stdlib.h&gt;
</span></span><span style="display:flex;"><span>  #include &lt;stdio.h&gt;
</span></span><span style="display:flex;"><span>  #include &lt;ctype.h&gt;
</span></span><span style="display:flex;"><span><span style="color:#f92672">- #include &#34;hello.h&#34; 
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span>  #include &lt;windows.h&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">+ /* file: adauditrpc-client.cpp */
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span>  #include &lt;stdlib.h&gt;
</span></span><span style="display:flex;"><span>  #include &lt;stdio.h&gt;
</span></span><span style="display:flex;"><span>  #include &lt;ctype.h&gt;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">+ #include &#34;ADAPAgentRpcPipe_h.h&#34; 
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span>  #include &lt;windows.h&gt;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">+ #pragma comment(lib, &#34;rpcrt4.lib&#34;)
</span></span></span></code></pre></div><p>Next step is to replace some data types and initiate variables to be used
for the RPC bindings. These can be found on lines 12-19.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span>     RPC_STATUS status;
</span></span><span style="display:flex;"><span><span style="color:#f92672">-    unsigned char * pszUuid             = NULL;
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">-    unsigned char * pszProtocolSequence = &#34;ncacn_np&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">-    unsigned char * pszNetworkAddress   = NULL;
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">-    unsigned char * pszEndpoint         = &#34;\\pipe\\hello&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">-    unsigned char * pszOptions          = NULL;
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">-    unsigned char * pszStringBinding    = NULL;
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">-    unsigned char * pszString           = &#34;hello, world&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span>     unsigned long ulCode;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     RPC_STATUS status;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    RPC_WSTR pszUuid = NULL;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    RPC_WSTR pszProtocolSequence = (RPC_WSTR)L&#34;ncacn_np&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    RPC_WSTR pszNetworkAddress = (RPC_WSTR)L&#34;100.64.5.212&#34;; // Target ADAudit agent
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    RPC_WSTR pszEndpoint = (RPC_WSTR)L&#34;\\pipe\\ADAPAgentRpcPipe&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    RPC_WSTR pszOptions = NULL;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    RPC_WSTR pszStringBinding = NULL;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    //unsigned char * pszString           = &#34;hello, world&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span>     unsigned long ulCode;
</span></span></code></pre></div><p>At line 29 we replace:</p>
<pre tabindex="0"><code>- status = RpcBindingFromStringBinding(pszStringBinding, &amp;hello_ClientIfHandle);
+ status = RpcBindingFromStringBinding(pszStringBinding, &amp;DefaultIfName_v1_0_c_ifspec);
</code></pre><p>And line 49:</p>
<pre tabindex="0"><code>- status = RpcBindingFree(&amp;hello_IfHandle);
+ status = RpcBindingFree(&amp;DefaultIfName_v1_0_c_ifspec);
</code></pre><p>The <code>&amp;DefaultIfName_v1_0_c_ifspec</code> parameter is defined in the header file
from our IDL compilation as we named our RPC interface <code>DefaultIfName</code>
(Line 5 in ADAPAgentRpcPipe.idl).</p>
<p>The last step would be to call the correct procedures as stated in our IDL:
<code>Proc0</code>, <code>Proc1</code> or <code>Proc2</code>. At this point in time we have no clue what the
procedures do when they are triggered on the agent side but we aim to find out.</p>
<p>At line 34 and 35 Microsoft&rsquo;s example code calls the example procedures
<code>HelloProc()</code> and <code>Shutdown()</code>. We will continue with replacing these with <code>Proc0</code>
and provide valid arguments to test our first ADAuditAgentRpcPipe procedure.</p>
<p>By reviewing our IDL structure for <code>Proc0</code> we also know that the
procedure takes two argument:</p>
<p><img src="adaudit-rpc-proc0-args.png" alt="adaudit-rpc-proc0-args"></p>
<p><code>arg_0</code> with datatype <code>long</code> which is an integer datatype
and <code>arg_1</code> with datatype <code>long*</code> which is a pointer to a long.
<code>arg_1</code> is defined with <code>[in][out]</code> meaning that this may be output from
the application.</p>
<p>As our IDL header structure lacks an implicit handle we need to provide a
handle (<code>&amp;DefaultIfName_v1_0_c_ifspec</code>) to <code>Proc0</code>, we&rsquo;ll also instantiate
variables for <code>arg_0</code> and <code>arg_1</code>:</p>
<pre tabindex="0"><code>-    RpcTryExcept
-    {
-        HelloProc(pszString);
-        Shutdown();
-    }

+    long arg_0 = 0;
+    long arg1_pointer;
+    long* arg_1 = &amp;arg1_pointer;
+    RpcTryExcept
+    {
+        Proc0(DefaultIfName_v1_0_c_ifspec, arg_0, arg_1);
+    }
</code></pre><p>In order for Visual Studio to reference <code>DefaultIfName_v1_0_c_ifspec</code>, we need to include the
<code>ADAPAgentRpcPipe_c.c</code> file in our list of source files:</p>
<p><img src="add-existing-item-to-visual-studio.png" alt="add-existing-item-to-visual-studio"></p>
<p>Also add the <code>ADAPAgentRpcPipe_h.h</code> file under <em>Header Files</em>.</p>
<p>The final project structure in Visual Studio should now look loo this:</p>
<p><img src="visual-studio-projekt-structure.png" alt="visual-studio-projekt-structure"></p>
<p>And if every step is followed  correctly the project should now build. Voil&hellip;</p>
<p><img src="build-of-adauditagentrpc-successful.png" alt="build-of-adauditagentrpc-successful"></p>
<p>But does it actually work?</p>
<p>Running the binary from the command line does not print any output unless an
exception is thrown but
if the network traffic is analyzed with Wireshark we can see
similar traffic to when the RPC interaction was triggered by
the ADAudit web application.</p>
<p><img src="adaudit-rpc-agent-now-working.png" alt="adaudit-rpc-agent-now-working"></p>
<p><strong>O.. M.. G.. it seems to work!</strong></p>
<h2 id="summary">Summary</h2>
<p>In this part of the research we successfully created a working RPC client
to interact with the ADAudit Agent. But we still don&rsquo;t know what either <code>Proc0</code>,
<code>Proc1</code> or <code>Proc2</code> does. In part 2, we dig into reverse engineering of
the agent software in an attempt to find out what we actually can do with
our newly created client.</p>
<p>Support us by following our LinkedIn page and get notified when new research
is published: <a href="https://www.linkedin.com/company/shelltrail">https://www.linkedin.com/company/shelltrail</a></p>
<p>Follow this URL to read part 2: <a href="/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part2/">https://www.shelltrail.com/research/manageengine-adaudit-reverse-engineering-windows-rpc-to-find-cve-2024-36036-and-cve-2024-36037-part2/</a></p>

    </div>

    



    
      








  





  
  
  
    
  
  
  <div class="media author-card" itemscope itemtype="http://schema.org/Person">
    

    <div class="media-body">
      <h5 class="card-title" itemprop="name"><a href="https://www.shelltrail.com/"></a></h5>
      
      
      <ul class="network-icon" aria-hidden="true">
        
      </ul>
    </div>
  </div>



      
      
    

    

    


  </div>
</article>

      

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script>
        
      

      
      
    

    
    

    
    
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    

    
    

    

    
    

    
    

    
    
    
    
    
    
    
    
    
    
    
    
    <script src="/js/academia.min.6c2ba2801d406881b3c2277043cedd76.js"></script>

    






  
  <div class="container">
    <footer class="site-footer">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-6 mb-4 mb-md-0">
        
        <p class="mb-0">
          Copyright  2025 &middot; 
	  Shelltrail AB 559319-6164
        </p>
      </div>
      <div class="col-md-6">
        <ul class="list-inline network-icon text-right mb-0">
          
          
        </ul>
      </div>
    </div>
  </div>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
